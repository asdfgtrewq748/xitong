# 系统启动指南

## 📋 目录
- [后端启动](#后端启动)
- [前端启动](#前端启动)
- [KYYC GUI 独立工具启动](#kyyc-gui-独立工具启动)
- [Docker 部署启动](#docker-部署启动)
- [常用命令速查](#常用命令速查)

---

## 后端启动

### 方式一：直接启动（开发模式）

```powershell
# 1. 进入后端目录
cd e:\xiangmu\xitong\backend

# 2. 启动 FastAPI 服务器（带热重载）
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 方式二：使用 Conda 环境启动

```powershell
# 1. 激活 conda 环境
conda activate xitong

# 2. 进入后端目录
cd e:\xiangmu\xitong\backend

# 3. 启动服务器
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 方式三：完整命令（使用 conda run）

```powershell
C:/ProgramData/anaconda3/Scripts/conda.exe run -p "C:\Users\Liu HaoTian\.conda\envs\kan" --no-capture-output python -m uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 后端访问地址

- **API 文档（Swagger）**: http://localhost:8000/docs
- **API 接口**: http://localhost:8000/api/...
- **健康检查**: http://localhost:8000/health

---

## 前端启动

### 方式一：开发模式启动

```powershell
# 1. 进入前端目录
cd d:\xitong\frontend

# 2. 安装依赖（首次或依赖更新时）
npm install

# 3. 启动开发服务器
npm run serve
```

### 方式二：生产模式构建

```powershell
# 1. 进入前端目录
cd d:\xitong\frontend

# 2. 构建生产版本
npm run build

# 3. 构建完成后，dist/ 目录包含生产文件
# 可以使用 Nginx 或其他静态服务器托管
```

### 前端访问地址

- **开发模式**: http://localhost:8080
- **生产模式**: 取决于 Nginx 配置（通常 http://localhost:80）

---

## KYYC GUI 独立工具启动

### 地质影响与矿压预测独立 GUI

```powershell
# 使用正确的 Python 环境启动
conda activate xitong
python e:\xiangmu\xitong\kYYC_gui.py
```

或简化版（如果环境已激活）：

```powershell
# 1. 激活环境
conda activate xitong

# 2. 启动 GUI
python e:\xiangmu\xitong\kYYC_gui.py
```

### 测试数据文件

系统已生成测试数据供 GUI 使用：
- `e:\xiangmu\xitong\test_kyyc_data.csv`
- `e:\xiangmu\xitong\test_kyyc_data.npz`

---

## Docker 部署启动

### 一键启动所有服务

```powershell
# 1. 进入项目根目录
cd e:\xiangmu\xitong

# 2. 构建并启动（首次或更新时）
docker-compose up --build -d

# 3. 仅启动（无需重新构建）
docker-compose up -d
```

### Docker 服务管理

```powershell
# 查看运行状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose stop

# 重启服务
docker-compose restart

# 停止并删除容器
docker-compose down

# 完全清理（包括数据卷）
docker-compose down -v
```

### Docker 访问地址

- **前端**: http://localhost
- **后端 API**: http://localhost:8000
- **API 文档**: http://localhost:8000/docs

---

## 常用命令速查

### 快速启动（最常用）

#### 后端
```powershell
cd e:\xiangmu\xitong\backend
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

#### 前端
```powershell
cd e:\xiangmu\xitong\frontend
npm run serve
```

#### KYYC GUI
```powershell
conda activate xitong
python e:\xiangmu\xitong\kYYC_gui.py
```

### 环境检查

```powershell
# 检查 Python 版本
python --version

# 检查 Node.js 版本
node -v

# 检查 npm 版本
npm -v

# 检查 Docker 版本
docker --version
docker-compose --version

# 检查 conda 环境
conda env list
```

### 依赖安装

```powershell
# 后端依赖
cd e:\xiangmu\xitong\backend
pip install -r requirements.txt

# 如果遇到文件上传错误，需要额外安装
pip install python-multipart

# 如果需要 DXF 导出功能，安装 ezdxf（注意：不是 szdxf）
pip install ezdxf==1.3.0
# 或使用 conda
conda install -c conda-forge ezdxf -y

# 前端依赖
cd e:\xiangmu\xitong\frontend
npm install

# KYYC GUI 依赖（已包含在后端 requirements.txt 中）
pip install PyQt5 matplotlib numpy pandas scipy scikit-learn
```

### 端口占用处理

如果端口被占用，可以修改端口：

```powershell
# 后端改用 8001 端口
uvicorn server:app --reload --host 0.0.0.0 --port 8001

# 前端改用 8081 端口（修改 vue.config.js 中的 devServer.port）
```

---

## 🔧 故障排查

### 后端无法启动

1. 检查 Python 环境是否正确
2. 检查依赖是否完整安装：`pip install -r requirements.txt`
3. **如果提示 "Form data requires python-multipart"**：
   ```powershell
   pip install python-multipart
   ```
4. 检查端口是否被占用：`netstat -ano | findstr :8000`
5. 查看错误日志

### 前端无法启动

1. 删除 `node_modules` 和 `package-lock.json`，重新安装：
   ```powershell
   rm -r node_modules
   rm package-lock.json
   npm install
   ```
2. 清理缓存：`npm cache clean --force`
3. 检查 Node.js 版本是否兼容

### 前端 API 连接失败 (ERR_CONNECTION_REFUSED)

如果看到以下错误：
- `Failed to load resource: net::ERR_CONNECTION_REFUSED`
- `WebSocket connection failed`

**原因**：后端服务器没有运行

**解决方案**：
1. 检查后端是否正在运行：
   ```powershell
   # 查看 8000 端口是否被占用
   netstat -ano | findstr :8000
   ```

2. 如果后端没有运行，启动后端：
   ```powershell
   cd d:\xitong\backend
   uvicorn server:app --reload --host 0.0.0.0 --port 8000
   ```

3. 确认后端启动成功后再访问前端页面

4. 如果后端运行在不同端口，修改环境变量：
   ```powershell
   # 在 frontend 目录创建 .env.local 文件
   # 内容：
   VUE_APP_API_PROXY=http://localhost:8001
   ```

### KYYC GUI 无法启动

1. 确认 PyQt5 已安装：`pip show PyQt5`
2. 使用正确的 conda 环境
3. 检查依赖完整性：`pip install PyQt5 matplotlib`

### Docker 启动失败

1. 确认 Docker Desktop 正在运行
2. 检查端口是否被占用
3. 查看日志：`docker-compose logs`
4. 重新构建：`docker-compose build --no-cache`

---

## � 快速诊断

### 前后端连接问题自查

如果前端页面无法加载数据，按以下步骤检查：

**步骤 1: 检查后端是否运行**
```powershell
# 方法 1: 检查端口
netstat -ano | findstr :8000

# 方法 2: 访问后端健康检查
# 在浏览器打开: http://localhost:8000/health
# 或使用 curl
curl http://localhost:8000/health
```

**步骤 2: 检查前端是否运行**
```powershell
# 检查前端端口
netstat -ano | findstr :8080

# 访问前端页面
# 在浏览器打开: http://localhost:8080
# 或 Docker 部署: http://localhost
```

**步骤 3: 检查网络配置**

在浏览器控制台 (F12) 查看：
- **Console** 标签页：查看是否有 `ERR_CONNECTION_REFUSED` 错误
- **Network** 标签页：查看 API 请求状态码

**常见错误及解决**：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `ERR_CONNECTION_REFUSED` | 后端未运行 | 启动后端服务 |
| `WebSocket connection failed` | 后端未运行或 WS 未配置 | 启动后端服务 |
| `404 Not Found` | API 路径错误 | 检查 API 地址配置 |
| `CORS error` | 跨域配置问题 | 检查后端 CORS 设置 |
| `500 Internal Server Error` | 后端代码错误 | 查看后端日志 |

---

##  获取帮助

- 查看完整文档：[README.md](./README.md)
- Docker 部署指南：[docs/DOCKER部署指南.md](./docs/DOCKER部署指南.md)
- 巷道支护计算：[docs/TUNNEL_SUPPORT_QUICKSTART.md](./docs/TUNNEL_SUPPORT_QUICKSTART.md)
- 快速开始：[docs/QUICKSTART.md](./docs/QUICKSTART.md)

---

## 🎯 巷道支护计算新功能

### 批量计算队列
- **添加到队列**：手动输入参数后，点击"添加到批量队列"按钮
- **队列管理**：可查看、删除队列中的条目
- **批量计算**：一键计算队列中所有参数

### 数据汇总与分析
- **搜索过滤**：在批量结果中快速搜索
- **统计分析**：查看平均值、最大值、最小值等统计信息
- **结果对比**：选择多条记录进行并排对比
- **详情查看**：点击"详情"查看单条记录的完整信息

### 历史记录
- **自动保存**：单次计算结果可添加到历史记录
- **本地存储**：历史记录保存在浏览器本地，关闭后不丢失
- **合并功能**：可将历史记录合并到当前批量结果

### 导出功能
- **CSV 导出**：导出单次或批量结果为 CSV 文件
- **Excel 支持**：CSV 文件可直接用 Excel 打开
- **复制结果**：快速复制计算结果到剪贴板

### 表格操作
- **多选功能**：勾选多条记录进行批量操作
- **排序功能**：点击列标题对数据排序
- **删除操作**：删除不需要的结果行

---

**最后更新**: 2025年11月3日
