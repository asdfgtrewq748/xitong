# 系统启动指南

## 📋 目录
- [后端启动](#后端启动)
- [前端启动](#前端启动)
- [KYYC GUI 独立工具启动](#kyyc-gui-独立工具启动)
- [Docker 部署启动](#docker-部署启动)
- [常用命令速查](#常用命令速查)

---

## 后端启动

### 方式一：直接启动（开发模式）

```powershell
# 1. 进入后端目录
cd e:\xiangmu\xitong\backend

# 2. 启动 FastAPI 服务器（带热重载）
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 方式二：使用 Conda 环境启动

```powershell
# 1. 激活 conda 环境
conda activate xitong

# 2. 进入后端目录
cd e:\xiangmu\xitong\backend

# 3. 启动服务器
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 方式三：完整命令（使用 conda run）

```powershell
C:/ProgramData/anaconda3/Scripts/conda.exe run -p "C:\Users\Liu HaoTian\.conda\envs\kan" --no-capture-output python -m uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

### 后端访问地址

- **API 文档（Swagger）**: http://localhost:8000/docs
- **API 接口**: http://localhost:8000/api/...
- **健康检查**: http://localhost:8000/health

---

## 前端启动

### 方式一：开发模式启动

```powershell
# 1. 进入前端目录
cd d:\xitong\frontend

# 2. 安装依赖（首次或依赖更新时）
npm install

# 3. 启动开发服务器
npm run serve
```

### 方式二：生产模式构建

```powershell
# 1. 进入前端目录
cd d:\xitong\frontend

# 2. 构建生产版本
npm run build

# 3. 构建完成后，dist/ 目录包含生产文件
# 可以使用 Nginx 或其他静态服务器托管
```

### 前端访问地址

- **开发模式**: http://localhost:8080
- **生产模式**: 取决于 Nginx 配置（通常 http://localhost:80）

---

## KYYC GUI 独立工具启动

### 地质影响与矿压预测独立 GUI

```powershell
# 使用正确的 Python 环境启动
conda activate xitong
python e:\xiangmu\xitong\kYYC_gui.py
```

或简化版（如果环境已激活）：

```powershell
# 1. 激活环境
conda activate xitong

# 2. 启动 GUI
python e:\xiangmu\xitong\kYYC_gui.py
```

### 测试数据文件

系统已生成测试数据供 GUI 使用：
- `e:\xiangmu\xitong\test_kyyc_data.csv`
- `e:\xiangmu\xitong\test_kyyc_data.npz`

---

## Docker 部署启动

### 一键启动所有服务

```powershell
# 1. 进入项目根目录
cd e:\xiangmu\xitong

# 2. 构建并启动（首次或更新时）
docker-compose up --build -d

# 3. 仅启动（无需重新构建）
docker-compose up -d
```

### Docker 服务管理

```powershell
# 查看运行状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose stop

# 重启服务
docker-compose restart

# 停止并删除容器
docker-compose down

# 完全清理（包括数据卷）
docker-compose down -v
```

### Docker 访问地址

- **前端**: http://localhost
- **后端 API**: http://localhost:8000
- **API 文档**: http://localhost:8000/docs

---

## 常用命令速查

### 快速启动（最常用）

#### 后端
```powershell
cd e:\xiangmu\xitong\backend
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

#### 前端
```powershell
cd e:\xiangmu\xitong\frontend
npm run serve
```

#### KYYC GUI
```powershell
conda activate xitong
python e:\xiangmu\xitong\kYYC_gui.py
```

### 环境检查

```powershell
# 检查 Python 版本
python --version

# 检查 Node.js 版本
node -v

# 检查 npm 版本
npm -v

# 检查 Docker 版本
docker --version
docker-compose --version

# 检查 conda 环境
conda env list
```

### 依赖安装

```powershell
# 后端依赖
cd e:\xiangmu\xitong\backend
pip install -r requirements.txt

# 如果遇到文件上传错误，需要额外安装
pip install python-multipart

# 如果需要 DXF 导出功能，安装 ezdxf（注意：不是 szdxf）
pip install ezdxf==1.3.0
# 或使用 conda
conda install -c conda-forge ezdxf -y

# 前端依赖
cd e:\xiangmu\xitong\frontend
npm install

# KYYC GUI 依赖（已包含在后端 requirements.txt 中）
pip install PyQt5 matplotlib numpy pandas scipy scikit-learn
```

### 端口占用处理

如果端口被占用，可以修改端口：

```powershell
# 后端改用 8001 端口
uvicorn server:app --reload --host 0.0.0.0 --port 8001

# 前端改用 8081 端口（修改 vue.config.js 中的 devServer.port）
```

---

## 🔧 故障排查

### 后端无法启动

1. 检查 Python 环境是否正确
2. 检查依赖是否完整安装：`pip install -r requirements.txt`
3. **如果提示 "Form data requires python-multipart"**：
   ```powershell
   pip install python-multipart
   ```
4. 检查端口是否被占用：`netstat -ano | findstr :8000`
5. 查看错误日志

### 前端无法启动

1. 删除 `node_modules` 和 `package-lock.json`，重新安装：
   ```powershell
   rm -r node_modules
   rm package-lock.json
   npm install
   ```
2. 清理缓存：`npm cache clean --force`
3. 检查 Node.js 版本是否兼容

### 前端 API 连接失败 (ERR_CONNECTION_REFUSED)

如果看到以下错误：
- `Failed to load resource: net::ERR_CONNECTION_REFUSED`
- `WebSocket connection failed`

**原因**：后端服务器没有运行

**解决方案**：
1. 检查后端是否正在运行：
   ```powershell
   # 查看 8000 端口是否被占用
   netstat -ano | findstr :8000
   ```

2. 如果后端没有运行，启动后端：
   ```powershell
   cd d:\xitong\backend
   uvicorn server:app --reload --host 0.0.0.0 --port 8000
   ```

3. 确认后端启动成功后再访问前端页面

4. 如果后端运行在不同端口，修改环境变量：
   ```powershell
   # 在 frontend 目录创建 .env.local 文件
   # 内容：
   VUE_APP_API_PROXY=http://localhost:8001
   ```

### KYYC GUI 无法启动

1. 确认 PyQt5 已安装：`pip show PyQt5`
2. 使用正确的 conda 环境
3. 检查依赖完整性：`pip install PyQt5 matplotlib`

### Docker 启动失败

1. 确认 Docker Desktop 正在运行
2. 检查端口是否被占用
3. 查看日志：`docker-compose logs`
4. 重新构建：`docker-compose build --no-cache`

---

## � 快速诊断

### 前后端连接问题自查

如果前端页面无法加载数据，按以下步骤检查：

**步骤 1: 检查后端是否运行**
```powershell
# 方法 1: 检查端口
netstat -ano | findstr :8000

# 方法 2: 访问后端健康检查
# 在浏览器打开: http://localhost:8000/health
# 或使用 curl
curl http://localhost:8000/health
```

**步骤 2: 检查前端是否运行**
```powershell
# 检查前端端口
netstat -ano | findstr :8080

# 访问前端页面
# 在浏览器打开: http://localhost:8080
# 或 Docker 部署: http://localhost
```

**步骤 3: 检查网络配置**

在浏览器控制台 (F12) 查看：
- **Console** 标签页：查看是否有 `ERR_CONNECTION_REFUSED` 错误
- **Network** 标签页：查看 API 请求状态码

**常见错误及解决**：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `ERR_CONNECTION_REFUSED` | 后端未运行 | 启动后端服务 |
| `WebSocket connection failed` | 后端未运行或 WS 未配置 | 启动后端服务 |
| `404 Not Found` | API 路径错误 | 检查 API 地址配置 |
| `CORS error` | 跨域配置问题 | 检查后端 CORS 设置 |
| `500 Internal Server Error` | 后端代码错误 | 查看后端日志 |

---

##  获取帮助

- 查看完整文档：[README.md](./README.md)
- Docker 部署指南：[docs/DOCKER部署指南.md](./docs/DOCKER部署指南.md)
- 巷道支护计算：[docs/TUNNEL_SUPPORT_QUICKSTART.md](./docs/TUNNEL_SUPPORT_QUICKSTART.md)
- 快速开始：[docs/QUICKSTART.md](./docs/QUICKSTART.md)

---

## 🎯 3D地质建模插值方法说明

### 剖面图坐标归一化功能（新增）

为了解决地质建模中坐标值过大、剖面图不便查看的问题,系统现已支持**剖面图坐标自动归一化**功能:

**功能特点**:
- ✅ **相对坐标显示**: X/Y/Z 轴剖面图均使用相对坐标系统
- ✅ **最小值作为原点**: 将坐标最小值映射为 0,其他点显示相对偏移量
- ✅ **便于查看**: 例如原始坐标 450000~452000 → 相对坐标 0~2000
- ✅ **保留绝对坐标**: Tooltip 中同时显示相对坐标和绝对坐标,便于定位
- ✅ **自动应用**: 所有剖面图(X/Y/Z)默认启用相对坐标
- ✅ **性能优化**: Z剖面自动降采样(3倍步长),大幅提升渲染速度

**性能优化说明**:
- Z剖面采用**3倍降采样**策略,例如 200×200 → 67×67
- 数据点从 40,000 减少到约 4,500,**渲染速度提升8-10倍**
- 前端启用**大数据量优化**模式:
  - `large: true` - 开启大数据优化
  - `progressive: 500` - 渐进式渲染
  - `animation: false` - 关闭动画减少开销
  - `symbolSize: 4` - 减小符号大小

**示例**:
```
原始坐标范围: X: 450000~452000, Y: 3980000~3982000
相对坐标范围: X: 0~2000, Y: 0~2000

剖面图显示: 0~2000 (清晰易读)
Tooltip显示: 
  - 相对坐标: 1250.5 m
  - 绝对坐标: 451250.5 m

性能提升:
  - 原始数据点: 40,000 (200×200)
  - 采样后数据点: ~4,500 (67×67)
  - 渲染时间: <1秒 (原先可能需要5-10秒)
```

**优势**:
- 📊 坐标范围从六位数缩小到千位数,便于缩放和查看
- 🎯 相对坐标更直观,快速了解地质体实际尺度
- 📍 保留绝对坐标信息,不影响精确定位
- ⚡ 大幅提升渲染性能,Z剖面生成更流畅

---

### 3D曲面图坐标归一化功能

为了解决3D曲面图坐标值过大的问题,系统支持**坐标自动归一化**功能:

**功能特点**:
- ✅ **从模型边界开始**: 3D曲面图 X/Y 轴从实际模型边界(最小值)开始,而非从 0 开始
- ✅ **归一化到 [0,1]**: 坐标值映射到 0~1 范围,避免显示过大数值(如原始坐标数千米时)
- ✅ **保留原始边界信息**: 系统内部保存原始坐标范围(`originalBounds`),可用于导出或标注
- ✅ **默认启用**: 3D曲面图(Surface3D)页面默认开启归一化,提升可视化体验

**使用说明**:
- **查看归一化效果**: 打开 3D曲面图页面,导入数据后 X/Y 轴将显示 0~1 范围的归一化坐标
- **关闭归一化**(如需原始坐标): 在 `Surface3DPage.vue` 配置中将 `normalizeCoordinates` 设为 `false`
- **获取原始坐标**: 归一化后的数据对象包含 `originalBounds: {xMin, xMax, yMin, yMax}`,可用于坐标映射

**示例**:
```javascript
// 原始坐标范围: X: 450000~452000, Y: 3980000~3982000
// 归一化后显示: X: 0~1, Y: 0~1
// 原始边界保存在: data.originalBounds = { xMin: 450000, xMax: 452000, yMin: 3980000, yMax: 3982000 }
```

---

### 可用的插值方法

系统提供多种插值方法,适用于不同的数据特征和建模需求:

#### 基础方法
- **linear** (线性插值)
  - 最快速,适合数据分布均匀的情况
  - 结果平滑但可能过于简化
  - 适合: 数据点较多且分布均匀的场景

- **nearest** (最近邻)
  - 最稳定,不会产生外推
  - 结果呈阶梯状,不够平滑
  - 适合: 数据点稀疏或作为安全回退

- **cubic** (三次样条)
  - 最平滑,需要较多数据点(≥10个)
  - 可能在边界产生轻微震荡
  - 适合: 数据点充足且需要高度平滑的场景

#### 高级方法
- **modified_shepard** (修正谢泼德插值)
  - 局部加权,保留数据细节
  - 距离近的点影响更大
  - 适合: 局部变化明显的地层

- **idw** (反距离加权)
  - 类似modified_shepard,但权重可调
  - 理论上不会外推,结果在原始数据范围内
  - 适合: 需要保守插值的场景

- **natural_neighbor** (自然邻点)
  - 基于Voronoi图,自然平滑
  - 对异常值不敏感
  - 适合: 数据分布不规则的情况

#### RBF系列方法
- **multiquadric** (多二次函数)
- **gaussian** (高斯函数)
- **thin_plate** (薄板样条)
- **linear_rbf** (线性RBF)
- **cubic_rbf** (三次RBF)
- **quintic_rbf** (五次RBF)
  - 全局平滑,可能产生外推
  - **已添加安全范围限制,防止异常值**
  - 结果限制在原始数据±50%范围内
  - quintic_rbf最平滑但也最容易产生异常值(已自动裁剪)
  - 适合: 需要全局平滑但要控制范围的场景

#### 克里金方法
- **ordinary_kriging** (普通克里金)
- **universal_kriging** (通用克里金)
  - 考虑空间自相关性
  - 提供不确定性估计
  - **已添加结果验证机制**
  - 适合: 地质统计学建模

#### 特殊方法
- **anisotropic** (各向异性插值)
  - 考虑地质构造的方向性
  - 适合褶皱、断层等定向地质体
  - **已添加异常值检测**
  - 适合: 有明显方向性的地层

### 插值方法选择建议

| 数据特征 | 推荐方法 | 备选方法 |
|---------|---------|---------|
| 数据点 < 10 | nearest | linear |
| 数据点 10-50 | linear, modified_shepard | cubic, idw |
| 数据点 > 50 | cubic, ordinary_kriging | universal_kriging |
| 数据分布均匀 | linear, cubic | multiquadric |
| 数据分布稀疏 | idw, nearest | modified_shepard |
| 需要极度平滑 | quintic_rbf, thin_plate | cubic, universal_kriging |
| 需要保守估计 | idw, nearest | linear |
| 有方向性构造 | anisotropic | thin_plate |

### 异常值处理机制

系统已对所有RBF系列、克里金和各向异性方法添加了自动异常值检测和裁剪:
- **检测范围**: 原始数据范围 ± 50%
- **超出范围**: 自动裁剪到安全范围
- **日志输出**: 显示检测和裁剪的异常值数量
- **特别保护**: quintic_rbf等高阶方法容易产生极端值,已强化保护

### 示例输出
```
[INTERP-RBF] ⚠️ 检测到12个异常值(范围: [50.2, 1235.8])
[INTERP-RBF] 📊 原始数据范围: [100.0, 500.0], 安全范围: [50.0, 700.0]
[INTERP-RBF] ✂️ 裁剪后范围: [50.2, 700.0]
```

### 网格分辨率设置

网格分辨率决定了3D模型的精细程度:

| 分辨率 | 网格点数 | 适用场景 | 计算时间 |
|--------|---------|---------|---------|
| 50 | 2,500 | 快速预览 | <1秒 |
| 100 | 10,000 | 测试验证 | 1-3秒 |
| **150** | **22,500** | **推荐展示** ✓ | 3-5秒 |
| 200 | 40,000 | 精细建模 | 5-10秒 |
| 250 | 62,500 | 超高精度 | 10-20秒 |
| 300 | 90,000 | 极致细节 | 20-40秒 |

**建议**:
- 📊 **初次建模**: 使用100快速查看效果
- 🎨 **展示汇报**: 使用150-200获得精细形状
- 🔬 **科研分析**: 使用250-300获得最高精度
- ⚡ **大范围数据**: 降低到80-100以提高速度

**注意**: 分辨率加倍,计算时间约增加4倍(网格点数是平方关系)

---

## 🎯 巷道支护计算新功能

### 批量计算队列
- **添加到队列**：手动输入参数后，点击"添加到批量队列"按钮
- **队列管理**：可查看、删除队列中的条目
- **批量计算**：一键计算队列中所有参数

### 数据汇总与分析
- **搜索过滤**：在批量结果中快速搜索
- **统计分析**：查看平均值、最大值、最小值等统计信息
- **结果对比**：选择多条记录进行并排对比
- **详情查看**：点击"详情"查看单条记录的完整信息

### 历史记录
- **自动保存**：单次计算结果可添加到历史记录
- **本地存储**：历史记录保存在浏览器本地，关闭后不丢失
- **合并功能**：可将历史记录合并到当前批量结果

### 导出功能
- **CSV 导出**：导出单次或批量结果为 CSV 文件
- **Excel 支持**：CSV 文件可直接用 Excel 打开
- **复制结果**：快速复制计算结果到剪贴板

### 表格操作
- **多选功能**：勾选多条记录进行批量操作
- **排序功能**：点击列标题对数据排序
- **删除操作**：删除不需要的结果行

---

**最后更新**: 2025年11月3日
