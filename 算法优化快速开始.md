# 算法优化 - 快速开始指南

**生成时间**: 2025-10-20
**优化版本**: v1.0

---

## 🚀 快速启动

### 1. 安装依赖

```bash
# 进入后端目录
cd backend

# 安装核心依赖(必需)
pip install numpy pandas scipy scikit-learn

# 可选: 安装pykrige获得真正的克里金插值
pip install pykrige

# 或使用requirements文件一键安装
pip install -r requirements-algorithm.txt
```

### 2. 验证安装

```bash
# 测试导入
python -c "from interpolation import get_interpolator; print('✅ 插值模块加载成功')"
python -c "from key_strata_calculator import KeyStrataCalculator; print('✅ 关键层模块加载成功')"
python -c "from data_validation import validate_geological_data; print('✅ 数据验证模块加载成功')"

# 可选: 测试pykrige
python -c "import pykrige; print('✅ pykrige已安装,支持真正的克里金插值')"
```

### 3. 启动后端服务

```bash
# 已集成到现有API,无需额外配置
cd backend
uvicorn server:app --reload --host 0.0.0.0 --port 8000

# 或使用Python直接运行
python server.py
```

---

## 📚 使用示例

### 示例1: 使用智能插值

```python
from interpolation import interpolate_smart
import numpy as np

# 准备数据
x = np.array([0, 1, 2, 3, 4])
y = np.array([0, 1, 2, 3, 4])
z = np.array([1.0, 2.5, 2.0, 3.5, 4.0])

# 插值网格
xi = np.linspace(0, 4, 20)
yi = np.linspace(0, 4, 20)
XI, YI = np.meshgrid(xi, yi)
xi_flat = XI.flatten()
yi_flat = YI.flatten()

# 智能插值(自动选择最佳方法)
z_pred, metadata = interpolate_smart(x, y, z, xi_flat, yi_flat, method='auto')

print(f"使用方法: {metadata['method_used']}")
print(f"数据质量: {metadata['data_quality']}")
print(f"数据点数: {metadata['n_points']}")
print(f"异常值已移除: {metadata['outliers_removed']}个")
```

### 示例2: 克里金插值

```python
from interpolation import get_interpolator

interpolator = get_interpolator()

# 普通克里金插值
z_pred = interpolator.ordinary_kriging(
    x, y, z, xi_flat, yi_flat,
    variogram_model='spherical'  # 可选: spherical, exponential, gaussian, linear
)

print(f"插值完成,结果形状: {z_pred.shape}")
```

### 示例3: 插值验证

```python
from interpolation import validate_interpolation
from scipy.interpolate import griddata

# 定义插值方法
def my_method(x_train, y_train, z_train, x_test, y_test):
    return griddata((x_train, y_train), z_train, (x_test, y_test), method='cubic')

# 交叉验证
results = validate_interpolation(x, y, z, my_method, k_folds=5)

print(f"MAE:  {results['mae']:.4f}")
print(f"RMSE: {results['rmse']:.4f}")
print(f"R²:   {results['r2']:.4f}")
print(f"95%置信区间: [{results['confidence_low']:.2f}, {results['confidence_high']:.2f}]")
```

### 示例4: 数据验证

```python
from data_validation import validate_geological_data
import pandas as pd

# 准备数据
df = pd.DataFrame({
    '岩层名称': ['砂岩', '泥岩', '煤层', '灰岩'],
    '厚度/m': [5.2, 3.1, 2.0, 8.5],
    '弹性模量/GPa': [22.0, 8.0, 5.0, 35.0],
    '容重/kN·m-3': [25.5, 20.0, 14.0, 27.0],
    '抗拉强度/MPa': [3.2, 1.5, 0.8, 5.5]
})

# 验证并自动修复
df_clean, result = validate_geological_data(df, strict=False, auto_fix=True)

print(f"验证结果: {'✅ 通过' if result.is_valid else '❌ 失败'}")
print(f"错误数: {len(result.errors)}")
print(f"警告数: {len(result.warnings)}")
print(f"修复数: {result.fixed_count}")

# 打印详细信息
for error in result.errors:
    print(f"  ❌ {error}")
for warning in result.warnings:
    print(f"  ⚠️  {warning}")
```

### 示例5: 关键层计算

```python
from key_strata_calculator import KeyStrataCalculator
import pandas as pd

# 准备岩层数据
df_strata = pd.DataFrame({
    '岩层名称': ['细砂岩', '泥岩', '中砂岩', '粗砂岩', '灰岩'],
    '厚度/m': [4.5, 2.0, 6.8, 5.2, 10.0],
    '弹性模量/GPa': [18.0, 8.0, 22.0, 25.0, 35.0],
    '容重/kN·m-3': [24.5, 20.0, 25.5, 26.0, 27.5],
    '抗拉强度/MPa': [2.8, 1.2, 3.5, 4.0, 5.5]
})

# 煤层数据
coal_df = pd.DataFrame({'厚度/m': [2.5]})

# 计算关键层
calculator = KeyStrataCalculator()
key_strata = calculator.calculate(df_strata, coal_df)

# 打印结果
print("识别的关键层:")
for ks in key_strata:
    print(f"  {ks['SK_Label']:8s} | {ks['岩性']:8s} | 厚度: {ks['厚度']:5.2f}m | 距煤层: {ks['距煤层距离']:5.2f}m")
```

---

## 📊 性能对比

### 运行性能测试

```python
import time
import numpy as np
from interpolation import interpolate_smart

# 生成测试数据
np.random.seed(42)
x = np.random.rand(100) * 100
y = np.random.rand(100) * 100
z = np.sin(x/10) + np.cos(y/10) + np.random.rand(100) * 0.5

xi = np.linspace(0, 100, 50)
yi = np.linspace(0, 100, 50)
XI, YI = np.meshgrid(xi, yi)
xi_flat = XI.flatten()
yi_flat = YI.flatten()

# 性能测试
start = time.time()
z_pred, metadata = interpolate_smart(x, y, z, xi_flat, yi_flat, method='auto')
elapsed = time.time() - start

print(f"✅ 插值完成")
print(f"   方法: {metadata['method_used']}")
print(f"   耗时: {elapsed*1000:.2f} ms")
print(f"   数据点: {metadata['n_points']}")
print(f"   输出点: {len(z_pred)}")
```

---

## 🔧 配置选项

### 插值方法选择

```python
# 可用方法:
methods = [
    'auto',              # 自动选择(推荐)
    'nearest',           # 最近邻
    'linear',            # 线性插值
    'cubic',             # 三次样条
    'kriging',           # 普通克里金
    'anisotropic',       # 各向异性
    'idw'               # 反距离加权
]

# 使用示例
z_pred, metadata = interpolate_smart(x, y, z, xi, yi, method='kriging')
```

### 克里金变差函数

```python
# 可用模型:
variogram_models = [
    'spherical',         # 球状模型(默认)
    'exponential',       # 指数模型
    'gaussian',          # 高斯模型
    'linear'            # 线性模型
]

# 使用示例
z_pred = interpolator.ordinary_kriging(
    x, y, z, xi, yi,
    variogram_model='exponential'
)
```

### 数据验证严格模式

```python
# 非严格模式(默认): 自动修复并给出警告
df_clean, result = validate_geological_data(df, strict=False, auto_fix=True)

# 严格模式: 发现问题立即抛出异常
try:
    df_clean, result = validate_geological_data(df, strict=True, auto_fix=False)
except ValueError as e:
    print(f"验证失败: {e}")
```

---

## 🐛 故障排除

### 问题1: 无法导入pykrige

**现象**:
```
ImportError: No module named 'pykrige'
```

**解决方案**:
```bash
# 安装pykrige
pip install pykrige

# 如果安装失败,系统会自动使用高斯RBF近似,仍可正常运行
# 不影响其他功能
```

### 问题2: 插值结果全是NaN

**原因**: 数据点太少或分布不合理

**解决方案**:
```python
# 使用智能插值,会自动处理
z_pred, metadata = interpolate_smart(x, y, z, xi, yi, method='auto')

# 或强制使用最近邻插值
z_pred, metadata = interpolate_smart(x, y, z, xi, yi, method='nearest')
```

### 问题3: 关键层计算返回空列表

**原因**: 输入数据不符合要求

**解决方案**:
```python
# 确保数据包含必需列
required_cols = ['岩层名称', '厚度/m', '弹性模量/GPa', '容重/kN·m-3', '抗拉强度/MPa']

# 检查数据
print(df_strata.columns)
print(df_strata.head())

# 确保煤层数据不为空
print(coal_df['厚度/m'].iloc[0])
```

### 问题4: 数据验证报告太多警告

**原因**: 数据质量问题

**解决方案**:
```python
# 查看具体警告
for warning in result.warnings:
    print(warning)

# 如果是合理的警告(如泥岩强度略高),可以忽略
# 如果是严重问题(如厚度为负),需要修正原始数据
```

---

## 📖 API参考

详见: [`docs/算法与业务逻辑优化报告.md`](docs/算法与业务逻辑优化报告.md)

---

## 🎯 下一步

1. ✅ 运行示例代码测试功能
2. ✅ 查看完整文档了解高级用法
3. ✅ 编写单元测试确保代码质量
4. ✅ 在生产环境中应用优化算法
5. ✅ 监控性能提升效果

---

## 📞 支持

- 📄 完整文档: `docs/算法与业务逻辑优化报告.md`
- 🐛 问题反馈: 项目issue页面
- 💬 技术交流: 开发团队

---

**祝使用愉快!** 🎉
