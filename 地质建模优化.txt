地质模型工程化导出功能技术方案

版本： v1.0

日期： 2025-05-20

状态： 规划中

目标： 打通 Web 地质建模与专业工程软件 (SketchUp, FLAC3D, Rhino) 的数据壁垒。

1. 背景与目标

1.1 当前痛点

目前的系统基于 Web (Vue3 + Python) 生成的三维地质模型，虽然视觉效果良好，但数据封闭在浏览器和数据库中。用户无法利用这些模型进行：

二次设计： 如在 SketchUp 中规划巷道、设备布置。

数值模拟： 如导入 FLAC3D 进行应力分析、沉陷预测。

1.2 建设目标

参考 Rhino (犀牛) 在岩土工程中的“中间件”角色，赋予我们的后端 Python 系统类似的数据转换能力。

SketchUp 通道： 导出分层 DXF 实体模型，支持推拉编辑。

FLAC3D 通道： 导出网格命令流 (.dat) 或几何表面 (.stl)，支持直接计算。

2. 技术架构设计

2.1 数据流转图

graph LR
    A[原始数据\n(钻孔/插值网格)] -->|Python Backend| B(内部几何对象\nPoints/Grid/Blocks)
    B --> C{导出控制器\nExport Manager}
    
    C -->|ezdxf| D[DXF 生成器]
    C -->|Native IO| E[FLAC3D 生成器]
    C -->|numpy-stl| F[STL 生成器]
    
    D --> G((.dxf 文件))
    E --> H((.dat/.f3grid 文件))
    F --> I((.stl 文件))
    
    G -->|导入| J[SketchUp / CAD]
    H -->|RUN| K[FLAC3D 计算]
    I -->|Geometry Import| K


2.2 新增模块结构

建议在 backend/ 目录下新增 exporters/ 包：

backend/
├── exporters/
│   ├── __init__.py
│   ├── base_exporter.py    # 基类，定义接口
│   ├── dxf_exporter.py     # 处理 SketchUp/CAD 导出
│   ├── flac3d_exporter.py  # 处理 FLAC3D 命令流导出
│   └── stl_exporter.py     # (可选) 处理纯几何表面导出
├── api.py                  # 新增导出 API 接口
└── ...


3. 详细实施步骤

第一阶段：SketchUp/CAD 接口 (DXF 导出)

目标： 生成带有图层信息的 3D 面体，导入 SketchUp 后可见、可编辑。

数据准备：

获取插值后的网格数据 (X, Y, Z)。通常是 Grid 形式。

将网格点转换为 拓扑面 (Faces)。例如，网格中相邻的四个点 $(i,j), (i+1,j), (i+1,j+1), (i,j+1)$ 构成一个 3DFACE。

核心库： ezdxf

关键逻辑：

创建 DXF 文档。

为每个地层创建一个 Layer (如 "Coal_Seam_1", "Sandstone")。

遍历网格，生成 MSP.add_3dface()。

注意： 必须导出为面，不能只导出点或线，否则 SketchUp 无法直接成面。

第二阶段：FLAC3D 接口 (数值模拟导出)

目标： 生成可直接运行的 FLAC3D 命令流文件 (.dat)。

数据准备：

需要体素化 (Voxel) 数据。利用现有的 coal_seam_blocks 模块。

每个 Block 需要包含：x_min, x_max, y_min, y_max, z_min, z_max 以及 Group (地层属性)。

坐标归一化 (重要)：

大地坐标 (如 X=3940000) 数值过大，会导致 FLAC3D 精度丢失。

必须在导出时将模型中心平移至 (0,0,0)。

核心逻辑：

遍历所有 Block。

拼接字符串生成命令：zone create brick point 0 ... group 'LayerName'。

写入 .dat 文本文件。

第三阶段：前端集成

UI 修改： 在 GeologicalModelingView.vue 工具栏增加 [导出模型] 下拉菜单。

API 对接：

POST /api/export/dxf -> 返回 .dxf 文件流。

POST /api/export/flac3d -> 返回 .dat 文件流。

4. 核心代码规范 (Reference)

4.1 DXF 导出规范

Entity Type: 3DFACE (最为通用) 或 MESH (更新版本的 DXF)。建议使用 3DFACE 兼容性最好。

Layers: 必须保留中文图层名或转换为拼音，防止乱码。

Color: 不同地层自动分配不同颜色索引 (ACI Color)。

4.2 FLAC3D 导出规范

Command Version: 兼容 FLAC3D 5.0 及 6.0+ 语法。

Grouping: 使用 group 'name' 语法进行分组，方便后续赋予力学参数。

Geometry: 确保网格没有负体积 (即点顺序必须符合右手法则)。

5. 测试与验收标准

测试项

预期结果

验收方法

DXF - SketchUp

文件导入 SketchUp 后，无需任何插件即可显示模型。

打开 SketchUp -> 文件 -> 导入 -> 选择导出的 DXF。检查是否生成了面，图层是否分离。

DXF - CAD

AutoCAD 打开正常，坐标正确。

使用 AutoCAD 打开，测量关键点坐标是否与数据库一致。

FLAC3D - Geometry

成功导入几何并生成网格。

FLAC3D 运行 geometry import，模型无报错。

FLAC3D - Grid

导入 .dat 文件后，直接显示划分好的单元体。

FLAC3D 运行 call model.dat，查看 Plot 是否有模型，Group 是否正确。

6. 总结

通过实施此方案，系统将具备“数据中台”的能力。DXF 解决了几何展示与二次编辑的问题，FLAC3D 脚本解决了科研计算的问题。这将极大地提升系统的工程实用价值。