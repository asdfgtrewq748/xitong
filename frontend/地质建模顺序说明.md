# 地质建模顺序说明

## 📋 建模流程概述

### 1. **建模顺序规则**

地质建模系统按照**从底部到顶部**的顺序依次堆叠岩层:

```
顶部 ↑
     │
     ├─ 第N层 (最后选择的岩层)
     │
     ├─ 第3层
     │
     ├─ 第2层
     │
     ├─ 第1层 (第一个选择的岩层)
     │
底部 ↓ (基底高程)
```

### 2. **具体建模算法**

#### 第一层 (底层):
```javascript
底面高程 = 基底高程 (base_level)
顶面高程 = 底面高程 + 第一层厚度
```

#### 第二层及以后:
```javascript
底面高程 = 上一层顶面高程 + 层间间隔 (gap)
顶面高程 = 底面高程 + 当前层厚度
```

### 3. **后端代码逻辑** (Python)

```python
# 初始化基底面
current_base_surface = np.full((rows, cols), base_level)

for seam_name in selected_seams:  # 按选择顺序遍历
    # 1. 当前层底面 = 基底面
    bottom_surface = current_base_surface.copy()
    
    # 2. 计算厚度网格 (通过插值)
    thickness_grid = interpolate(x, y, thickness_data)
    
    # 3. 当前层顶面 = 底面 + 厚度
    top_surface = bottom_surface + thickness_grid
    
    # 4. 保存模型
    models.append(BlockModel(
        name=seam_name,
        top_surface=top_surface,
        bottom_surface=bottom_surface
    ))
    
    # 5. 更新基底面为当前层顶面 + 间隔
    current_base_surface = top_surface + gap_value
```

---

## 🎨 颜色分配规则

### 1. **煤层识别**
- 系统自动检测岩层名称中是否包含 **"煤"** 字
- 所有煤层统一显示为 **黑色 (#000000)**

示例:
- `煤层1` → 黑色
- `3号煤` → 黑色
- `主采煤层` → 黑色

### 2. **相同岩层名称**
- 系统维护一个 `岩层名称 → 颜色` 的映射表
- 相同名称的岩层使用相同颜色
- 不同名称的岩层使用不同颜色

示例:
```javascript
砂岩 (第1次出现) → #2c5aa0 (蓝色)
泥岩 (第1次出现) → #52883d (绿色)
砂岩 (第2次出现) → #2c5aa0 (蓝色，与第1次相同)
泥岩 (第2次出现) → #52883d (绿色，与第1次相同)
```

### 3. **颜色池**
系统预定义了15种深色调颜色:
```javascript
[
  '#2c5aa0', // 深蓝
  '#52883d', // 深绿
  '#d4941e', // 金黄
  '#c73e3a', // 深红
  '#2e91b8', // 青色
  '#2d7a54', // 墨绿
  '#d65a2c', // 橙色
  '#7841a3', // 紫色
  '#c94f9f', // 品红
  '#a67845', // 棕色
  '#6b4428', // 深棕
  '#3e4f5c', // 深灰蓝
  '#8a94a0', // 灰色
  '#8b3a62', // 紫红
  '#5c6b2f'  // 橄榄绿
]
```

### 4. **代码实现**

```javascript
const layerColorMap = new Map(); // 岩层名称 → 颜色映射

function getColorForLayer(layerName) {
  // 1. 判断是否为煤层
  if (layerName.includes('煤')) {
    return '#000000'; // 黑色
  }
  
  // 2. 查找已分配的颜色
  if (layerColorMap.has(layerName)) {
    return layerColorMap.get(layerName);
  }
  
  // 3. 为新岩层分配颜色
  const colorIndex = layerColorMap.size % layerColors.length;
  const color = layerColors[colorIndex];
  layerColorMap.set(layerName, color);
  
  return color;
}
```

---

## 🖼️ 背景颜色优化

### 修改内容:

1. **3D场景背景**: 纯白色
   ```javascript
   backgroundColor: '#ffffff'
   ```

2. **环境光背景**: 自动模式
   ```javascript
   environment: 'auto'  // 让ECharts自动处理环境光反射
   ```

3. **网格线颜色**: 浅灰色
   ```javascript
   splitLine: {
     lineStyle: {
       color: 'rgba(0, 0, 0, 0.1)'  // 10%不透明度的黑色
     }
   }
   ```

4. **坐标轴线**: 灰色
   ```javascript
   axisLine: {
     lineStyle: {
       color: '#999'
     }
   }
   ```

---

## 📊 使用建议

### 1. **合理安排岩层顺序**

❌ 错误示例 (自下而上):
```
煤层 → 砂岩 → 泥岩
```

✅ 正确示例 (符合地质顺序):
```
泥岩 (底部老地层)
  ↓
砂岩 (中间)
  ↓
煤层 (顶部新地层)
```

### 2. **设置合理的基底高程**

- 如果第一层是最深的地层,设置较低的基底高程
- 例如: 如果最深地层在 -500m, 可设置基底为 -520m

### 3. **使用层间间隔**

- 当岩层紧密堆叠难以区分时,可设置小的间隔 (0.5 ~ 2m)
- 仅用于可视化,不影响实际厚度计算

### 4. **煤层命名规范**

为了让系统正确识别煤层,建议命名包含"煤"字:
- ✅ `3号煤`、`煤层1`、`主采煤层`
- ❌ `C3`、`Layer1` (不会识别为煤层)

---

## 🔍 调试信息

生成模型时,浏览器控制台会输出详细的建模信息:

```
========== 建模顺序信息 ==========
建模顺序说明: 岩层从底部到顶部依次堆叠
每一层的底面 = 上一层的顶面 + 间隔(gap)
1. 泥岩 (15个数据点)
2. 砂岩 (12个数据点)
3. 3号煤 (8个数据点)
=================================
```

---

## 💡 常见问题

### Q1: 为什么我的煤层不是黑色?
**A:** 检查岩层名称是否包含"煤"字。如果使用英文或数字命名,系统无法识别。

### Q2: 为什么相同岩层颜色不一样?
**A:** 确保岩层名称完全相同(包括空格、标点)。`砂岩1` 和 `砂岩 1` 会被视为不同岩层。

### Q3: 如何调整岩层顺序?
**A:** 在**步骤2**中重新选择岩层,按照期望的顺序点选。

### Q4: 背景还是不是纯白色?
**A:** 
1. 确保浏览器已清除缓存
2. 检查是否有浏览器主题或扩展影响显示
3. 尝试使用无痕模式测试

---

**更新时间**: 2025-10-22
**版本**: v2.1
