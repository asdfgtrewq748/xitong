# 地质建模块体渲染修复说明

## 问题描述

用户反馈地质建模功能生成的是"一层一层的曲面"，而不是真正的块体。期望的效果是：
1. 每一层都是一个完整的块体（有顶面、底面和四个侧面）
2. 第一层：底面基于`base_level`，顶面 = 底面 + 厚度
3. 第二层：底面 = 第一层顶面 + gap，顶面 = 底面 + 厚度
4. 依此类推，层层堆叠

## 后端逻辑验证

检查 `backend/coal_seam_blocks/modeling.py` 中的 `build_block_models` 函数，确认逻辑**已正确实现**：

```python
# 第一层
bottom_surface = current_base_surface.copy()  # 从base_level开始
top_surface = bottom_surface + thickness_grid  # 顶面 = 底面 + 厚度

# 更新下一层的底面
current_base_surface = top_surface  # 下一层底面 = 上一层顶面
if gap_value:
    current_base_surface = current_base_surface + float(gap_value)  # 加上层间间隔
```

**结论**：后端逻辑完全符合要求，问题出在前端渲染。

## 前端渲染问题

### 原有实现
前端只渲染了每个岩层的顶面和底面两个surface：
- 顶面surface
- 底面surface

这导致：
- 看起来像两个独立的曲面悬浮在空中
- 没有侧面连接，无法形成块体感
- 透视时可以"看穿"岩层

### 修复方案

为每个岩层添加**完整的六个面**：
1. **顶面**：top_surface
2. **底面**：bottom_surface  
3. **前侧面**：Y最小边界，连接顶面和底面
4. **后侧面**：Y最大边界，连接顶面和底面
5. **左侧面**：X最小边界，连接顶面和底面
6. **右侧面**：X最大边界，连接顶面和底面

### 实现细节

#### 1. 顶面和底面
保持原有的surface实现，但增加不透明度：
```javascript
// 顶面
{
  type: 'surface',
  name: `${model.name} (顶)`,
  data: topZFlat.map((z, idx) => {
    const j = idx % model.grid_x.length;
    const i = Math.floor(idx / model.grid_x.length);
    return [model.grid_x[j], model.grid_y[i], z];
  }),
  itemStyle: {
    color: layerColor,
    opacity: 0.85  // 增加不透明度
  }
}
```

#### 2. 四个侧面
使用`parametric`类型的surface，通过参数方程定义侧面：

**前侧面（Y最小）：**
```javascript
{
  type: 'surface',
  name: `${model.name} (前侧)`,
  parametric: true,
  parametricEquation: {
    u: { min: 0, max: xLen - 1, step: 1 },  // 沿X方向
    v: { min: 0, max: 1, step: 1 },         // 从底到顶
    x: (u, v) => model.grid_x[Math.floor(u)],
    y: (u, v) => model.grid_y[0],           // Y固定在最小值
    z: (u, v) => {
      const j = Math.floor(u);
      // v=0时返回底面Z值，v=1时返回顶面Z值
      return v === 0 ? model.bottom_surface_z[0][j] : model.top_surface_z[0][j];
    }
  },
  itemStyle: {
    color: layerColor,
    opacity: 0.7  // 侧面稍微透明
  }
}
```

**其他三个侧面**采用类似逻辑：
- 后侧：Y固定在`model.grid_y[yLen-1]`
- 左侧：X固定在`model.grid_x[0]`，u沿Y方向变化
- 右侧：X固定在`model.grid_x[xLen-1]`，u沿Y方向变化

### 渲染效果优化

1. **不透明度设置**：
   - 顶面：0.85（煤层）或 0.75（其他岩层）
   - 底面：0.85 * 0.85 = 0.72（稍微透明）
   - 侧面：0.7（更透明，便于观察内部）

2. **网格线**：
   - 顶面：较粗的网格线（width: 0.8）
   - 底面：较细的网格线（width: 0.6）
   - 侧面：最细的网格线（width: 0.5）

3. **材质设置**：
   - 使用`lambert`或`realistic`着色模式
   - 调整粗糙度和金属度，增强真实感

## 修改文件

### 前端文件
- `frontend/src/components/GeologicalModelingView.vue`
  - 修改3D模型渲染逻辑（约1050-1200行）
  - 为每个岩层添加6个surface（顶、底、前、后、左、右）

### 后端文件
- `backend/server.py`
  - 添加详细日志输出，便于调试数据一致性问题
  - 在`/api/modeling/columns`、`/api/modeling/contour`和`/api/modeling/block_model`接口中添加日志

## 测试要点

### 1. 块体完整性测试
- [ ] 每一层岩层看起来是完整的块体
- [ ] 侧面正确连接顶面和底面
- [ ] 没有"悬浮"的曲面

### 2. 层叠效果测试
- [ ] 第一层底面从`base_level`开始
- [ ] 每一层顶面 = 该层底面 + 厚度
- [ ] 下一层底面 = 上一层顶面 + gap
- [ ] 层与层之间正确堆叠，没有重叠或间隙异常

### 3. 视觉效果测试
- [ ] 旋转视图时，块体保持完整
- [ ] 透视时可以看到前后层次关系
- [ ] 煤层（黑色）与其他岩层（彩色）区分明显
- [ ] 网格线清晰但不过于突出

### 4. 数据一致性测试
- [ ] 全局数据和上传文件建模结果完全一致
- [ ] 相同数据源生成相同的块体模型
- [ ] 日志输出显示数据范围一致

## 使用建议

### 参数设置
1. **分辨率（resolution）**：
   - 低分辨率（20-40）：快速预览，但块体边缘可能不够平滑
   - 中等分辨率（60-80）：推荐，平衡性能和效果
   - 高分辨率（100-150）：精细模型，但可能较慢

2. **基底高程（base_level）**：
   - 设置为最底层岩层的底面高程
   - 通常为负值（地下）或0

3. **层间间隔（gap）**：
   - 0：层紧密堆叠，真实显示
   - 0.1-1.0：便于区分各层，适合展示
   - 过大：可能看起来不自然

### 视图控制
1. **俯仰角（alpha）**：
   - 0-30°：俯视，便于观察层次
   - 45°：等角视图
   - 60-90°：侧视，便于观察厚度

2. **距离（distance）**：
   - 自动计算的初始值通常合适
   - 增大：看到更多全局信息
   - 减小：看到更多细节

3. **渲染模式**：
   - lambert：性能好，效果清晰
   - realistic：更真实，但性能要求高
   - color：最快，但缺少光照效果

## 已知限制

1. **性能**：每个岩层需要渲染6个surface，大量岩层可能影响性能
2. **透明度**：多层透明surface叠加可能产生视觉干扰
3. **网格密度**：高分辨率时，侧面的参数曲面可能计算较慢

## 未来改进方向

1. **体积渲染**：使用echarts-gl的volume类型，真正的体积渲染
2. **LOD（细节层次）**：根据视距动态调整分辨率
3. **交互增强**：点击块体显示详细信息，支持隐藏/显示单个岩层
4. **导出增强**：支持导出为通用3D格式（OBJ、STL等）

## 修复日期

2025年10月29日

## 相关文档

- [地质建模全局数据修复说明.md](./地质建模全局数据修复说明.md) - 数据一致性修复
- [地质建模顺序说明.md](../frontend/地质建模顺序说明.md) - 建模顺序和参数说明
