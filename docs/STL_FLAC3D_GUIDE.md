# 分层STL导入到 FLAC3D 指南

本指南说明如何将由系统导出的“分层STL ZIP包”导入到 FLAC3D，并逐层生成网格与材料设置。该ZIP包由前端“STL 分层导出”生成，通常包含：多个按序号命名的STL文件、`manifest.json`、`README.txt` 和 `import_to_flac3d.fish`（可选自动化脚本）。

**目标读者**：熟悉FLAC3D基础界面的工程师或地质建模人员。

---

## 准备工作

- 已安装 FLAC3D（建议版本：6.x 或更新）。
- 将ZIP包下载到本地（例如：`E:\projects\model_export\geological_model.zip`）。
- 建议在一个空目录下解压，以便管理多个STL文件。

---

## ZIP 包结构（示例）

```
geological_model.zip
├─ 01_coal_6.stl
├─ 02_sandy_mudstone.stl
├─ 03_coal_5.stl
├─ manifest.json
├─ README.txt
└─ import_to_flac3d.fish
```

- `01_coal_6.stl`：第1层的封闭六面体STL文件（编号+英文层名，避免FLAC3D中文兼容性问题）。
- `manifest.json`：包含各层元数据（名称、厚度、建议网格尺寸等）。
- `import_to_flac3d.fish`：可选FISH脚本，尝试自动在FLAC3D中导入每个STL并生成 zones（注意：脚本可能需根据本地FLAC3D版本或项目路径微调）。

---

## 快速导入（使用随包提供的FISH脚本）

1. 解压ZIP到目标目录，例如：`C:\work\stl_layers`。
2. 启动 FLAC3D GUI。推荐在FLAC3D中创建一个新工程/工作目录并切换到该目录。
3. 在FLAC3D里通过菜单 `Tools -> Run script`（或 `File -> Run script`）打开并执行 `import_to_flac3d.fish`。或在命令行/批处理里调用（依据你的FLAC3D安装方式）：

```powershell
# 示例（视FLAC3D支持的命令行而定）
# flac3d -i import_to_flac3d.fish
```

4. 脚本运行完成后，检查每一层是否已被导入为独立的几何体/zone。若全部成功，按需要设置材料属性并生成网格。

> 注意：自动脚本在不同 FLAC3D 版本、工作目录或许可环境下可能需要修改路径或部分命令，请在第一次运行前在文本编辑器中检查脚本内容。

---

## 手动逐层导入（更稳妥的方式）

如果自动脚本失败或你想手动检查每一层，请按下列步骤操作：

1. 在 FLAC3D 中，新建或打开一个工程，确保当前工作目录与STL文件所在目录一致。
2. 对于每个STL文件，依次执行：
   - 菜单 `File -> Import -> Geometry -> STL`（或使用命令行接口）导入STL文件，命名为 `layer_01_coal` 等便于识别的名字。
   - 导入时选择“封闭曲面”选项（如果有），确保FLAC3D识别为封闭实体。
   - 导入后，使用 `create brick` / `zone` 或 `mesh` 功能将该几何体填充为计算单元（zones）。通常需要指定单元尺寸或分裂参数，参考 `manifest.json` 中的建议网格尺寸。
   - 为该zone分配材料编号和物理参数（密度、弹性模量、摩擦角等）。
3. 按从上到下（或从地表到深处）的顺序导入每一层并生成网格。因为每层是独立封闭体，不会形成内部分层面，FLAC3D将在每层内生成独立的zone集合。
4. 如果需要在不同层之间建立粘结或接触关系，请在FLAC3D中使用接口/接触定义功能，而不是依赖导入的几何面。

---

## 常见问题与解决方法

- 问：导入后FLAC3D提示“表面未封闭”或“非流形几何体”。
  - 答：请先在网格/建模软件（如Meshlab或Rhino）中检查STL，确保每个STL为封闭流形（manifold）。若不是，尝试在系统导出时提高降采样质量或在导出界面选择更高的分辨率。

- 问：生成网格后，出现重叠或拓扑错误。
  - 答：确认你使用的是“分层STL”模式（每层独立文件）。若误用了单文件STL或DXF，可能包含内部分层面，导致重叠。推荐使用本方法重新导出。

- 问：坐标位置不对或尺度异常。
  - 答：如果导出时选择了“坐标归一化”，请在FLAC3D中使用manifest或README中提供的scale/offset信息进行逆归一化或直接在FLAC3D中按相同缩放系数放置模型。

- 问：FISH脚本执行中断或命令未识别。
  - 答：打开 `import_to_flac3d.fish`，逐行检查脚本中的文件路径和命令。不同FLAC3D版本对FISH命令支持略有差异，必要时将脚本改为按层手动执行命令。

---

## 验证清单（导入完成后）

- [ ] 每个STL被识别为封闭体并已导入
- [ ] 每层已成功生成 zone（数量符合预期）
- [ ] 无内部自相交或重复面导致的网格错误
- [ ] 各层材料与参数已正确分配
- [ ] 如需要，已对接触或接口进行定义并验证

---

## 进阶技巧

- 若希望进一步控制网格细化，可在导出时在系统侧设置更小的采样步长，或在FLAC3D中按局部区域细化网格。
- 对于非常薄的岩层，建议提高采样精度或在FLAC3D中使用专门的薄层 meshing 策略，以避免零厚或数值不稳定。

---

如需，我可以：

- 根据你当前导出的 `manifest.json` 生成一个针对你模型的示例 `import_to_flac3d.fish`（包含具体文件名和建议网格尺寸）。
- 或者，我可以把这份指南整合进仓库 `docs/` 下的 README 或导出ZIP里的 `README.txt` 模板中。

如果要我生成定制化的 FISH 脚本，请把一个示例 ZIP 或 `manifest.json` 给我，或允许我读取最近生成的 `manifest.json`。