# 地质建模顺序优化说明

## 问题描述

用户反馈图例中的岩层顺序不正确。原有实现使用字母排序，导致地质顺序混乱。

## 根本原因

在 `backend/server.py` 的 `/api/modeling/seams` 接口中，岩层名称使用了简单的字母排序：
```python
unique_values = sorted({v for v in values if v})
```

这会导致：
- "岩层10" 排在 "岩层2" 前面（字母顺序）
- 与地质实际顺序（从下到上）不符
- 建模时底层和顶层位置错误

## 地质建模的正确顺序

地质建模应该**从下到上**堆叠：
1. **第1层**（最底层）：底面 = base_level，顶面 = 底面 + 厚度
2. **第2层**：底面 = 第1层顶面 + gap，顶面 = 底面 + 厚度
3. **第3层**：底面 = 第2层顶面 + gap，顶面 = 底面 + 厚度
4. 依此类推...

因此，传递给建模函数的 `selected_seams` 数组的顺序至关重要，必须是**从底到顶**的地质顺序。

## 修复方案

### 1. 后端智能排序

修改 `/api/modeling/seams` 接口，支持按序号列排序：

```python
@app.get("/api/modeling/seams")
async def get_unique_seams(column: str = Query(..., description="岩层列名")):
    modeling_state.ensure_loaded()
    df = modeling_state.merged_df
    
    # 检查是否有序号列
    sequence_col = None
    for possible_col in ['序号', '序号(从下到上)', '层序', '编号', 'sequence', 'order']:
        if possible_col in df.columns:
            sequence_col = possible_col
            break
    
    # 获取唯一岩层名称
    unique_values = [v for v in df[column].dropna().astype(str).str.strip().unique() if v]
    
    # 如果有序号列，按序号排序
    if sequence_col:
        seam_order = {}
        for seam in unique_values:
            seam_data = df[df[column].astype(str).str.strip() == seam]
            # 使用该岩层的最小序号（最底层位置）
            min_seq = pd.to_numeric(seam_data[sequence_col], errors='coerce').min()
            if pd.notna(min_seq):
                seam_order[seam] = min_seq
        
        # 按序号从小到大排序（从底到顶）
        unique_values = sorted(unique_values, key=lambda x: seam_order.get(x, float('inf')))
    else:
        # 没有序号列，使用字母排序（不理想但可预测）
        unique_values = sorted(unique_values)
    
    return {"status": "success", "values": unique_values}
```

### 2. 前端UI提示

在岩层选择界面添加明确的顺序说明：

```vue
<el-alert type="warning" :closable="false" show-icon>
  <b>重要提示：</b>岩层将按照列表顺序从下到上堆叠建模。
  • 如果数据包含"序号"列，系统已自动按序号排序
  • 请确保第一个岩层是最底层，最后一个是最顶层
</el-alert>
```

### 3. 建模参数说明更新

更新建模顺序说明卡片：
```
• 岩层按列表顺序从下到上依次堆叠
• 第1层（列表第一个）：底面 = 基底高程，顶面 = 底面 + 厚度
• 第2层开始：底面 = 上一层顶面 + 间隔，顶面 = 底面 + 厚度
• 如有"序号"列，已自动按序号排序（从小到大）
```

## 支持的序号列名称

系统会自动检测以下列名：
- `序号`
- `序号(从下到上)`
- `层序`
- `编号`
- `sequence`
- `order`

如果找到任一列，将使用该列的数值进行排序。

## 排序逻辑

1. **有序号列**：
   - 为每个岩层找到最小序号（代表该岩层的最底部位置）
   - 按序号从小到大排序
   - 序号越小 → 越靠底层 → 越早建模

2. **无序号列**：
   - 回退到字母排序
   - 虽然不是最理想，但至少是确定的、可预测的

## 示例

### 数据示例
```
钻孔名  | 序号 | 岩层名称 | 厚度
-------+------+----------+------
ZK001  | 1    | 砂岩     | 5.0
ZK001  | 2    | 煤层3    | 2.0
ZK001  | 3    | 泥岩     | 8.0
ZK001  | 4    | 煤层5    | 3.0
```

### 排序结果
使用序号排序后的顺序（从下到上）：
1. 砂岩（序号1）- 最底层
2. 煤层3（序号2）
3. 泥岩（序号3）
4. 煤层5（序号4）- 最顶层

### 建模结果
- **砂岩**：底面 = base_level (如0m)，顶面 = 0 + 5.0 = 5.0m
- **煤层3**：底面 = 5.0 + gap，顶面 = 底面 + 2.0
- **泥岩**：底面 = 煤层3顶面 + gap，顶面 = 底面 + 8.0
- **煤层5**：底面 = 泥岩顶面 + gap，顶面 = 底面 + 3.0

## 图例顺序

修复后，图例中的岩层顺序将与建模顺序一致：
- 从上到下显示：顶层岩层在图例顶部，底层岩层在图例底部
- 或从下到上显示：底层岩层在图例顶部，顶层岩层在图例底部

这取决于前端的展示逻辑，但无论如何，顺序都应该与地质顺序保持一致。

## 用户操作建议

1. **数据准备**：
   - 确保CSV文件包含"序号"列
   - 序号应该从1开始，从底到顶递增
   - 每个钻孔的序号都应该一致

2. **岩层选择**：
   - 检查列表中的岩层顺序是否合理
   - 第一个应该是最底层岩层
   - 最后一个应该是最顶层岩层
   - 如果顺序不对，可以取消部分岩层的选择

3. **参数设置**：
   - base_level：设置为最底层的底面高程
   - gap：层间间隔，用于3D展示区分各层

## 测试要点

- [ ] 有序号列的数据：岩层按序号正确排序
- [ ] 无序号列的数据：岩层按字母排序（虽然不完美但可预测）
- [ ] 图例顺序与建模顺序一致
- [ ] 3D模型中底层确实在底部，顶层在顶部
- [ ] 日志输出显示排序方式

## 相关文件

- `backend/server.py` - `/api/modeling/seams` 接口修改
- `frontend/src/components/GeologicalModelingView.vue` - UI提示添加

## 修复日期

2025年10月29日
