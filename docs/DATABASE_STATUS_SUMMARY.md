# Docker éƒ¨ç½²æ•°æ®åº“åŠ è½½é—®é¢˜åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ

## ðŸ“‹ é—®é¢˜çŽ°çŠ¶

### âœ… å·²è§£å†³çš„é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| å®¹å™¨å¯åŠ¨å¤±è´¥ | âœ… å·²è§£å†³ | ä¼˜åŒ–äº†å¥åº·æ£€æŸ¥,ä½¿ç”¨å†…ç½®åº“ urllib |
| å¥åº·æ£€æŸ¥è¶…æ—¶ | âœ… å·²è§£å†³ | å¢žåŠ å¯åŠ¨æ—¶é—´åˆ° 60s, é‡è¯• 5 æ¬¡ |
| æ•°æ®åº“é”™è¯¯å¯¼è‡´å´©æºƒ | âœ… å·²è§£å†³ | æ·»åŠ äº†å®Œå–„çš„é”™è¯¯å¤„ç†å’Œä¼˜é›…é™çº§ |
| å®¹å™¨é‡å¯æ•°æ®ä¸¢å¤± | âœ… å·²è§£å†³ | é…ç½®äº†æ•°æ®å·æŒä¹…åŒ– |
| å‰ç«¯æ˜¾ç¤ºé”™è¯¯ | âœ… å·²è§£å†³ | API è¿”å›žå‹å¥½æç¤ºä¿¡æ¯ |

### âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç†çš„æƒ…å†µ

**æ•°æ®åº“ä¸ä¼šè‡ªåŠ¨åˆå§‹åŒ–**

- å®¹å™¨å¯åŠ¨æ—¶,æ•°æ®åº“æ–‡ä»¶ (`/app/data/database.db`) é»˜è®¤ä¸å­˜åœ¨
- CSV æ•°æ®éœ€è¦æ‰‹åŠ¨å¯¼å…¥
- è¿™æ˜¯ **è®¾è®¡å†³ç­–**,ç¬¦åˆ Docker æœ€ä½³å®žè·µ

---

## ðŸŽ¯ å½“å‰éƒ¨ç½²æµç¨‹

### æ­¥éª¤ 1: å¯åŠ¨å®¹å™¨
```bash
docker compose up -d
```

**ç»“æžœ:**
- âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ
- âœ… å¥åº·æ£€æŸ¥é€šè¿‡
- âœ… å‰ç«¯å¯ä»¥è®¿é—®
- âš ï¸ æ•°æ®åº“ä¸ºç©º (æ˜¾ç¤º "æ•°æ®åº“å°šæœªåˆå§‹åŒ–,è¯·å…ˆå¯¼å…¥æ•°æ®")

### æ­¥éª¤ 2: åˆå§‹åŒ–æ•°æ®åº“ (å¿…éœ€)

**Windows æœ¬åœ°:**
```cmd
init-database-simple.bat
```

**Linux æœåŠ¡å™¨:**
```bash
bash init-database.sh
```

**æ‰‹åŠ¨æ‰§è¡Œ:**
```bash
# 1. å¤åˆ¶ CSV åˆ°å®¹å™¨
docker cp data/input/æ±‡æ€»è¡¨.csv mining-backend:/app/data/input/æ±‡æ€»è¡¨.csv

# 2. æ‰§è¡Œå¯¼å…¥
docker exec mining-backend python /app/scripts/import_database.py \
  --csv /app/data/input/æ±‡æ€»è¡¨.csv \
  --database /app/data/database.db
```

### æ­¥éª¤ 3: éªŒè¯
è®¿é—® http://localhost æ•°æ®åº“æŸ¥çœ‹å™¨,åº”è¯¥çœ‹åˆ° 1343 æ¡è®°å½•ã€‚

---

## ðŸ” ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨åˆå§‹åŒ–?

### Docker æœ€ä½³å®žè·µ

1. **æ•°æ®ä¸Žåº”ç”¨åˆ†ç¦»**
   - åº”ç”¨ä»£ç (é•œåƒ) â‰  æ•°æ®(å·)
   - æ•°æ®åº”è¯¥é€šè¿‡å·æŒ‚è½½,ä¸åº”æ‰“åŒ…è¿›é•œåƒ

2. **çµæ´»æ€§**
   - ç”¨æˆ·å¯èƒ½æœ‰ä¸åŒçš„æ•°æ®æº
   - ç”Ÿäº§çŽ¯å¢ƒå¯èƒ½ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“(MySQL, PostgreSQL)
   - å…è®¸ç”¨æˆ·é€‰æ‹©ä½•æ—¶å¯¼å…¥æ•°æ®

3. **é¿å…é‡å¤æ“ä½œ**
   - å®¹å™¨é‡å¯ä¸åº”é‡æ–°å¯¼å…¥æ•°æ®
   - æ•°æ®æŒä¹…åŒ–åŽæ— éœ€å†æ¬¡åˆå§‹åŒ–

4. **é•œåƒä½“ç§¯**
   - ä¸å°†å¤§åž‹ CSV æ‰“åŒ…è¿›é•œåƒ
   - ä¿æŒé•œåƒè½»é‡

---

## ðŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ

### âœ… æ–¹æ¡ˆ 1: å¯åŠ¨æ—¶æ£€æŸ¥å¹¶æç¤º (å·²å®žçŽ°)

ä¿®æ”¹äº† `backend/server.py` å¯åŠ¨äº‹ä»¶:

```python
@app.on_event("startup")
async def startup_event():
    # ... å…¶ä»–åˆå§‹åŒ– ...
    
    # æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    if db_path.exists():
        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if count > 0:
            print(f"âœ“ æ•°æ®åº“å·²åŠ è½½ ({count} æ¡è®°å½•)")
        else:
            print("âš  æ•°æ®åº“ä¸ºç©º,è¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬å¯¼å…¥æ•°æ®")
    else:
        print("âš  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨,è¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬å¯¼å…¥æ•°æ®")
        print("  æç¤º: docker exec mining-backend python /app/scripts/import_database.py")
```

**ä¼˜ç‚¹:**
- å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€
- ç»™å‡ºæ˜Žç¡®çš„åˆå§‹åŒ–æŒ‡ä»¤
- ä¸ä¼šå½±å“å®¹å™¨å¯åŠ¨

**æŸ¥çœ‹æç¤º:**
```bash
docker logs mining-backend
```

### ðŸ“¦ æ–¹æ¡ˆ 2: æž„å»ºæ—¶åŒ…å«ç¤ºä¾‹æ•°æ® (å¯é€‰)

ä¿®æ”¹ `backend/Dockerfile`,åœ¨æž„å»ºé˜¶æ®µå¯¼å…¥æ•°æ®:

```dockerfile
# åœ¨æž„å»ºé˜¶æ®µå¤åˆ¶ CSV å¹¶åˆå§‹åŒ–
COPY ../data/input/æ±‡æ€»è¡¨.csv /app/data/input/æ±‡æ€»è¡¨.csv
COPY scripts/import_database.py /app/scripts/

# åˆå§‹åŒ–æ•°æ®åº“
RUN python /app/scripts/import_database.py \
    --csv /app/data/input/æ±‡æ€»è¡¨.csv \
    --database /app/data/database.db
```

**ä¼˜ç‚¹:**
- å¼€ç®±å³ç”¨,æ— éœ€æ‰‹åŠ¨å¯¼å…¥
- é€‚åˆæ¼”ç¤ºå’Œå¼€å‘çŽ¯å¢ƒ

**ç¼ºç‚¹:**
- é•œåƒä½“ç§¯å˜å¤§ (å¢žåŠ çº¦ 100MB)
- æ•°æ®æ›´æ–°éœ€è¦é‡æ–°æž„å»ºé•œåƒ
- ä¸é€‚åˆç”Ÿäº§çŽ¯å¢ƒ

### ðŸš€ æ–¹æ¡ˆ 3: ä½¿ç”¨ entrypoint è„šæœ¬è‡ªåŠ¨æ£€æŸ¥ (æŽ¨è)

åˆ›å»ºå¯åŠ¨è„šæœ¬,åœ¨å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥:

```bash
#!/bin/bash
# entrypoint.sh

# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•°æ®
if [ ! -f /app/data/database.db ] || [ ! -s /app/data/database.db ]; then
    echo "æ•°æ®åº“ä¸å­˜åœ¨æˆ–ä¸ºç©º"
    if [ -f /app/data/input/æ±‡æ€»è¡¨.csv ]; then
        echo "æ£€æµ‹åˆ° CSV æ–‡ä»¶,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“..."
        python /app/scripts/import_database.py \
            --csv /app/data/input/æ±‡æ€»è¡¨.csv \
            --database /app/data/database.db
        echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
    else
        echo "è­¦å‘Š: æœªæ‰¾åˆ° CSV æ–‡ä»¶,æ•°æ®åº“å°†ä¸ºç©º"
    fi
fi

# å¯åŠ¨åº”ç”¨
exec uvicorn server:app --host 0.0.0.0 --port 8000 --workers 2
```

ä¿®æ”¹ Dockerfile:
```dockerfile
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh
ENTRYPOINT ["/app/entrypoint.sh"]
```

**ä¼˜ç‚¹:**
- è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜
- åªåœ¨é¦–æ¬¡å¯åŠ¨æ—¶å¯¼å…¥
- å®¹å™¨é‡å¯ä¸ä¼šé‡å¤å¯¼å…¥

**å®žçŽ°æ­¤æ–¹æ¡ˆ:**
```bash
# åˆ›å»º entrypoint è„šæœ¬
cat > backend/entrypoint.sh << 'EOF'
#!/bin/bash
# ... (ä¸Šè¿°è„šæœ¬å†…å®¹)
EOF

# é‡æ–°æž„å»ºé•œåƒ
docker compose build backend
docker compose up -d
```

---

## ðŸ“Š å½“å‰çŠ¶æ€æ€»ç»“

### å®¹å™¨è¡Œä¸º

| åœºæ™¯ | å®¹å™¨å¯åŠ¨ | å¥åº·æ£€æŸ¥ | API è®¿é—® | å‰ç«¯æ˜¾ç¤º |
|-----|---------|---------|---------|---------|
| æ•°æ®åº“æœªåˆå§‹åŒ– | âœ… æˆåŠŸ | âœ… é€šè¿‡ | âœ… æ­£å¸¸ | æ˜¾ç¤ºæç¤ºä¿¡æ¯ |
| æ•°æ®åº“å·²åˆå§‹åŒ– | âœ… æˆåŠŸ | âœ… é€šè¿‡ | âœ… æ­£å¸¸ | æ˜¾ç¤ºæ•°æ® |
| æ•°æ®åº“æŸå | âœ… æˆåŠŸ | âœ… é€šè¿‡ | âœ… æ­£å¸¸ | æ˜¾ç¤ºé”™è¯¯æç¤º |

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**æ•°æ®åº“æœªåˆå§‹åŒ–æ—¶:**
```
======================================================================
            Mining System API å¯åŠ¨ä¸­...
======================================================================
âš  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨,è¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬å¯¼å…¥æ•°æ®
  æç¤º: å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–:
    docker exec mining-backend python /app/scripts/import_database.py
[æ€§èƒ½é…ç½®] å·²åŠ è½½é…ç½®
å½“å‰å†…å­˜ä½¿ç”¨: 125.3MB
ç³»ç»Ÿæ€»å†…å­˜: 16384.0MB
ç³»ç»Ÿå¯ç”¨å†…å­˜: 8192.5MB
======================================================================
```

**æ•°æ®åº“å·²åŠ è½½æ—¶:**
```
======================================================================
            Mining System API å¯åŠ¨ä¸­...
======================================================================
âœ“ æ•°æ®åº“å·²åŠ è½½ (1343 æ¡è®°å½•)
[æ€§èƒ½é…ç½®] å·²åŠ è½½é…ç½®
å½“å‰å†…å­˜ä½¿ç”¨: 128.7MB
ç³»ç»Ÿæ€»å†…å­˜: 16384.0MB
ç³»ç»Ÿå¯ç”¨å†…å­˜: 8192.5MB
======================================================================
```

---

## ðŸŽ“ æœ€ä½³å®žè·µå»ºè®®

### å¼€å‘çŽ¯å¢ƒ
ä½¿ç”¨ **æ–¹æ¡ˆ 3 (entrypoint è„šæœ¬)**:
- è‡ªåŠ¨åˆå§‹åŒ–
- æ–¹ä¾¿æµ‹è¯•
- å‡å°‘æ‰‹åŠ¨æ“ä½œ

### ç”Ÿäº§çŽ¯å¢ƒ
ä½¿ç”¨ **æ–¹æ¡ˆ 1 (å½“å‰æ–¹æ¡ˆ)**:
- æ‰‹åŠ¨æŽ§åˆ¶æ•°æ®å¯¼å…¥
- æ•°æ®ä¸Žåº”ç”¨åˆ†ç¦»
- å¯ä½¿ç”¨å¤–éƒ¨æ•°æ®æº

### æ¼”ç¤ºçŽ¯å¢ƒ
ä½¿ç”¨ **æ–¹æ¡ˆ 2 (æž„å»ºæ—¶åŒ…å«æ•°æ®)**:
- å¼€ç®±å³ç”¨
- æ— éœ€é¢å¤–æ“ä½œ
- é€‚åˆå¿«é€Ÿæ¼”ç¤º

---

## ðŸ“ æ“ä½œæ¸…å•

### é¦–æ¬¡éƒ¨ç½²
- [ ] å¯åŠ¨å®¹å™¨: `docker compose up -d`
- [ ] ç­‰å¾…å¥åº·æ£€æŸ¥: `docker ps` (æŸ¥çœ‹ healthy çŠ¶æ€)
- [ ] åˆå§‹åŒ–æ•°æ®åº“: `init-database-simple.bat` (Windows) æˆ– `bash init-database.sh` (Linux)
- [ ] éªŒè¯æ•°æ®: è®¿é—® http://localhost/database

### æ›´æ–°æ•°æ®
- [ ] å‡†å¤‡æ–°çš„ CSV æ–‡ä»¶
- [ ] å¤åˆ¶åˆ°å®¹å™¨: `docker cp æ–°æ–‡ä»¶.csv mining-backend:/app/data/input/æ±‡æ€»è¡¨.csv`
- [ ] é‡æ–°å¯¼å…¥: `docker exec mining-backend python /app/scripts/import_database.py`

### å®¹å™¨é‡å¯
- [ ] é‡å¯å®¹å™¨: `docker compose restart`
- [ ] âœ… æ•°æ®è‡ªåŠ¨ä¿ç•™ (å› ä¸ºä½¿ç”¨äº†å·æŒ‚è½½)
- [ ] âœ… æ— éœ€é‡æ–°å¯¼å…¥

### å®Œå…¨é‡æ–°éƒ¨ç½²
- [ ] åœæ­¢å¹¶åˆ é™¤: `docker compose down`
- [ ] æ¸…ç†æ•°æ®(å¯é€‰): `rm -rf backend/data/database.db`
- [ ] é‡æ–°å¯åŠ¨: `docker compose up -d`
- [ ] é‡æ–°å¯¼å…¥æ•°æ®: `init-database-simple.bat`

---

## âœ… ç»“è®º

### é—®é¢˜å›žç­”: "çŽ°åœ¨çš„ç¨‹åºéƒ¨ç½²åˆ°dockerä¸­æ˜¯å¦æ²¡æœ‰æ•°æ®åº“æœªåŠ è½½çš„é—®é¢˜äº†"

**æŠ€æœ¯ä¸Š: âœ… æ˜¯çš„**
- å®¹å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨
- ä¸ä¼šå› ä¸ºæ•°æ®åº“é—®é¢˜è€Œå´©æºƒ
- API ä¼šä¼˜é›…åœ°å¤„ç†æ•°æ®åº“æœªåˆå§‹åŒ–çš„æƒ…å†µ

**ç”¨æˆ·ä½“éªŒ: âš ï¸ éƒ¨åˆ†æ˜¯**
- å®¹å™¨å¯åŠ¨åŽæ•°æ®åº“æ˜¯ç©ºçš„
- **éœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–è„šæœ¬**
- åˆå§‹åŒ–åŽ,æ•°æ®ä¼šæŒä¹…ä¿å­˜

**æŽ¨èåšæ³•:**
1. å¯åŠ¨å®¹å™¨åŽç«‹å³è¿è¡Œ `init-database-simple.bat`
2. æˆ–è€…å®žçŽ°æ–¹æ¡ˆ 3 (entrypoint è‡ªåŠ¨æ£€æŸ¥)
3. æ•°æ®åº“åªéœ€åˆå§‹åŒ–ä¸€æ¬¡,ä¹‹åŽè‡ªåŠ¨æŒä¹…åŒ–

**æ€»ç»“:**
- ä¸ä¼šæœ‰"åŠ è½½å¤±è´¥"çš„é—®é¢˜ âœ…
- ä½†ä»éœ€"æ‰‹åŠ¨åˆå§‹åŒ–"æ•°æ® âš ï¸
- è¿™æ˜¯è®¾è®¡å†³ç­–,ä¸æ˜¯ç¼ºé™· â„¹ï¸

---

## ðŸ“ž éœ€è¦å¸®åŠ©?

å¦‚æžœé‡åˆ°é—®é¢˜:
1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—: `docker logs mining-backend`
2. æ£€æŸ¥å¥åº·çŠ¶æ€: `docker ps`
3. è¿è¡Œè¯Šæ–­è„šæœ¬: `bash diagnose.sh`
4. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£: `docs/DATABASE_INIT_GUIDE.md`
