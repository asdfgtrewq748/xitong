# 顶板层自动生成功能说明

## 功能概述

在进行FLAC3D建模时,模型顶部需要是平坦的表面,以便正确施加上覆载荷。本功能自动在最顶层上方添加一个"顶板"层,其特点是:

- **底面**: 跟随最顶层地质体的曲面起伏
- **顶面**: 完全平坦的水平面
- **厚度**: 可自定义,默认10米

## 使用方法

### 前端导出时配置

在前端导出STL时,可以通过以下参数控制顶板层:

```javascript
// 前端导出配置示例
const exportOptions = {
  format: "binary",
  downsample_factor: 5,
  normalize_coords: true,
  
  // 顶板层配置
  add_top_plate: true,           // 是否添加顶板(默认true)
  top_plate_thickness: 15.0      // 顶板厚度(米,默认10m)
};
```

### 后端API调用

```python
from exporters.layered_stl_exporter import LayeredSTLExporter

exporter = LayeredSTLExporter()
result = exporter.export_layered(data, output_path, {
    "format": "binary",
    "downsample_factor": 5,
    "normalize_coords": True,
    "add_top_plate": True,          # 启用顶板
    "top_plate_thickness": 15.0     # 厚度15米
})
```

### 禁用顶板层

如果不需要顶板层,可以显式禁用:

```python
options = {
    "add_top_plate": False
}
```

## 技术实现

### 自动计算逻辑

1. **获取最顶层数据**: 读取地层列表中第一个地层的顶面数据
2. **计算最高点**: `max_z = np.nanmax(top_surface_z)`
3. **构建顶板层**:
   - 底面高程: `bottom_surface_z = top_surface_z` (跟随曲面)
   - 顶面高程: `top_surface_z = max_z + thickness` (平坦水平面)

### 示例数据

假设最顶层(6煤)的顶面高程范围是 95.01m ~ 104.97m:

```
原始地层:
  6煤: 顶面 [95.01, 104.97]m (起伏地形)

添加顶板后(厚度15m):
  顶板: 顶面 119.97m (平坦), 底面 [95.01, 104.97]m (跟随地形)
  6煤: 顶面 [95.01, 104.97]m
```

## 导出结果

导出文件中会自动包含顶板层:

```
01_layer.stl         # 顶板层 (自动生成)
02_coal_6.stl        # 6煤层
03_sandstone.stl     # 砂岩层
...
manifest.json        # 元数据
import_to_flac3d.fish # FLAC3D导入脚本
```

## FLAC3D中的应用

### 施加上覆载荷

有了平坦的顶板层后,可以轻松施加均布载荷:

```fish
; 在顶板顶面施加载荷
zone face apply stress-normal [压力值] range group 'top_plate' face top
```

### 边界条件

顶板层提供了明确的上边界,便于设置:

```fish
; 固定顶板顶面
zone face apply velocity-z 0 range group 'top_plate' face top
```

## 流形网格保证

顶板层同样使用改进的流形网格生成算法:

- ✅ 所有边恰好被2个三角形共享
- ✅ 无非流形边
- ✅ 可直接导入FLAC3D进行网格化

## 配置建议

### 顶板厚度选择

| 模型规模 | 建议厚度 | 说明 |
|---------|---------|------|
| 小型(< 1km²) | 5-10m | 足够覆盖地形起伏 |
| 中型(1-10km²) | 10-20m | 平衡计算效率和精度 |
| 大型(> 10km²) | 20-50m | 确保载荷分布均匀 |

### 特殊情况

- **地形起伏剧烈**: 增加厚度,确保 `thickness > max_terrain_relief`
- **深部开采**: 顶板厚度相对于埋深可以较小
- **浅部开采**: 增加厚度以模拟上覆岩层

## 测试验证

已通过完整测试:
- ✅ 顶板底面正确跟随地形起伏
- ✅ 顶板顶面完全平坦
- ✅ 流形网格验证通过
- ✅ 与其他地层无缝衔接
- ✅ Unicode编码问题已修复

## 常见问题

### Q: 顶板层会增加多少计算量?

A: 非常少。顶板层通常只有数千到数万个单元,相比整个模型可忽略不计。

### Q: 可以手动编辑顶板层吗?

A: 可以。导出后修改 `01_layer.stl` 或在FLAC3D中调整顶板网格。

### Q: 顶板层的材料属性如何设置?

A: 在FLAC3D中导入后,可以为顶板区域分配特定的材料属性:

```fish
zone cmodel assign elastic range group 'top_plate'
zone property density 2500 bulk 1e9 shear 5e8 range group 'top_plate'
```

### Q: 如果不需要顶板怎么办?

A: 设置 `add_top_plate: false` 即可禁用。

---

**更新时间**: 2025年11月22日
**版本**: v1.0
**作者**: AI Assistant
