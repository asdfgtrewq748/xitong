# FLAC3D原生网格格式(.f3grid)导出指南

## 概述

**方案三:F3GRID T4 网格导出** - 彻底消除FLAC3D层间重叠问题的终极方案

### 核心优势

1. **拓扑直接定义** - 无需STL的三角面片→体积转换,直接定义节点和单元
2. **层间节点共享** - 上层底面节点ID = 下层顶面节点ID,完美对接
3. **零几何冲突** - 不依赖geometry import,避免FLAC3D网格生成时的体积冲突
4. **应力自然传递** - 相邻层通过节点ID复用,应力场连续
5. **文本格式调试** - .f3grid为文本文件,便于检查和验证

## 快速开始

### 1. 前端操作

1. 在"地质建模"页面完成建模
2. 点击"导出模型"
3. 选择导出格式: **FLAC3D 原生网格 (T4)**
4. 配置参数:
   - **坐标归一化**: 开启(推荐) - 避免大坐标精度问题
   - **最小四面体体积**: 默认 `1e-6` 立方米, 可根据地层精度调节
5. 点击导出,下载`.f3grid`文件

### 2. FLAC3D导入

在FLAC3D中执行:

```fish
; 导入F3GRID网格, 保留导出的节点/单元ID
zone import f3grid "path/to/model.f3grid" use-given-ids

; 查看网格统计
zone list information

; 查看分组(按地层)
zone group list
```

**无需手动生成网格!** F3GRID已包含完整网格拓扑。

### 3. 赋予材料参数

```fish
; 为各层分别赋予材料参数
zone cmodel assign mohr-coulomb range group "煤6"
zone property bulk 1e9 shear 0.5e9 range group "煤6"
zone property cohesion 1e6 friction 30 range group "煤6"

zone cmodel assign mohr-coulomb range group "砂质泥岩"
zone property bulk 2e9 shear 1e9 range group "砂质泥岩"
zone property cohesion 2e6 friction 35 range group "砂质泥岩"
```

## 文件格式说明

### 基本结构

```
* ====================================
* FLAC3D Native Grid File
* Generated by CoalSeam3D System
* ====================================
* Total GridPoints: 12345
* Total Zones: 10000
* Total Groups: 8
* ...

* GRIDPOINTS
*   G <id> <x> <y> <z>
G 1 394000.000000 4380000.000000 -500.000000
G 2 394000.000000 4380000.000000 -505.000000
...

* ZONES tetra
*   Z T4 <id> <gp0> <gp1> <gp2> <gp3>
Z T4 1 1 5 6 10
Z T4 2 1 6 4 10
...

* GROUPS
ZGROUP 'L01_coal'
1 2 3 4 5 6 7 8 9 10

ZGROUP 'L02_sandy_mudstone'
101 102 103 104 105 106 107 108 109 110
...
```

### T4 拆分策略

```
Hex 柱节点编号 (底面逆时针, 顶面对应):
   7 ----------- 6
   /|            /|
  / |           / |
 4 ----------- 5  |
 |  |          |  |
 |  3 ---------|- 2
 | /           | /
 |/            |/
 0 ----------- 1

拆分为 6 个四面体:
   (0, 1, 2, 6)
   (0, 2, 3, 6)
   (0, 3, 7, 6)
   (0, 7, 4, 6)
   (0, 4, 5, 6)
   (0, 5, 1, 6)

当任意 T4 的体积 < `min_tet_volume` 时自动跳过, 避免 FLAC3D "zone geometry" 告警。
```

## 与其他格式对比

| 格式 | STL分层 | F3GRID | 说明 |
|------|---------|--------|------|
| **导入方式** | `geometry import` | `zone import f3grid` | F3GRID直接导入网格 |
| **网格生成** | 需要FLAC3D生成 | 已预生成 | F3GRID节省时间 |
| **层间连接** | 可能有微小gap | 节点ID复用,零gap | F3GRID完美对接 |
| **应力传递** | 需手动attach | 自动连续 | F3GRID物理正确 |
| **几何冲突** | 可能存在 | 不存在 | F3GRID拓扑直接定义 |
| **调试难度** | STL二进制难读 | 文本格式易读 | F3GRID便于检查 |

## 技术细节

### 导出选项

| 选项键 | 说明 | 默认 |
|--------|------|------|
| `normalize_coords` | 使用区域中位值进行坐标偏移, 避免大地坐标导致的浮点精度丢失 | `false` |
| `coordinate_offset` | 手动指定 `(x, y, z)` 偏移 (覆盖 normalize 结果) | `null` |
| `min_tet_volume` | 判断四面体退化的最小体积(立方米); 过小单元会被剔除 | `1e-6` |

> 说明: 每个 `ZGROUP` 名称会自动转换为 ASCII, 例如 `6煤` → `6coal`, `砂质泥岩` → `sandy_mudstone`, 以确保 FLAC3D 在读取 `.f3grid` 时不会因为中文或特殊字符而报错。

### 层间节点共享策略

1. **第一层(最下层)**:
   - 创建底面节点(bottom_nodes)
   - 创建顶面节点(top_nodes)
   - 将单个 Hex 柱拆分为 6 个 T4 zone

2. **第二层及以上**:
   - **复用前一层的顶面节点**作为本层底面
   - 创建新的顶面节点
   - 继续执行六分法生成 T4 zone

**结果**: 相邻层在 interface 处共享节点 ID, Z 坐标完全一致, 仍然保证零 gap, 但再也不会出现 BRICK 扭曲导致的负体积 warning。

### 逐列强制排序保证

导出前,系统已执行`enforce_columnwise_order()`:

1. 对每个(y,x)垂直柱,按bottom深度排序
2. 自下而上重新设置bottom/top,保证min_gap
3. 验证无重叠后才允许导出

**这确保了F3GRID文件中相邻层的Z坐标对齐!**

### 坐标归一化

**问题**: 大地坐标(如X=3940000)会导致FLAC3D浮点精度丢失

**解决**: 开启归一化后:
```
原始坐标: (3940000, 4380000, -500)
归一化后: (0, 0, -500)
```

**注意**: 
- 归一化仅影响XY,不影响Z
- 结果分析时需手动加回偏移量
- 原始坐标信息记录在文件头注释中

## 常见问题

### Q: F3GRID比STL文件大很多?
A: 是的,F3GRID是文本格式且包含完整网格拓扑,但:
- 文件大小不影响FLAC3D导入速度
- 文本格式便于调试和验证
- 可用gzip压缩后传输

### Q: 导入时提示“Zone geometry can only support one overlay”? 
A: 这是 FLAC3D 的网格质量告警, 表示个别 BRICK 单元的内部四面体体积为 0 或非常小。可以：
- 在导出时开启 `filter_bad_zones`(或 `enforce_zone_quality`) 并调整 `min_zone_thickness`, 自动剔除几何质量最差的单元。
- 在 FLAC3D 中执行 `zone geometry-test`, 观察 condition 分布, 如仅少量单元警告可继续计算。

### Q: 能否在FLAC3D中修改网格?
A: 可以,导入后可以:
- 细化网格: `zone densify`
- 删除zones: `zone delete`
- 添加zones: `zone create`

### Q: 如何验证层间节点共享?
A: 在FLAC3D中:
```fish
; 查看interface处的节点
zone gridpoint list position-x 100 position-y 200
; 如果有两个zone引用同一个gridpoint ID,说明共享成功
```

### Q: 导出失败怎么办?
A: 检查:
1. 是否已执行"加载并合并数据"
2. 是否选择了地层
3. 建模是否成功(无报错)
4. 后端日志是否有详细错误

## 后续步骤(步骤7:测试验证)

完成导出后,需要:

1. **FLAC3D导入测试**:
   - 验证网格导入无错误
   - 检查zone数量是否正确
   - 验证group分组

2. **层间连接验证**:
   - 检查interface处的gridpoint是否被两层共享
   - 验证Z坐标一致性

3. **应力传递测试**:
   - 施加边界条件
   - 运行简单载荷测试
   - 检查应力场是否连续

4. **性能测试**:
   - 对比STL方案的网格生成时间
   - 对比计算收敛速度

## 总结

F3GRID格式是消除FLAC3D层间重叠的**终极方案**:

✅ 无需STL的几何转换,直接定义拓扑  
✅ 层间节点ID复用,完美对接  
✅ 零几何冲突,零应力断裂  
✅ 文本格式,易于调试  
✅ 已集成逐列排序,数据质量保证  

**开始使用F3GRID,告别红蓝马赛克!** 🎉
