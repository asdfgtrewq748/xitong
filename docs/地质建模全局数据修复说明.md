# 地质建模全局数据修复说明

## 问题描述

地质建模功能在使用全局数据和上传新数据时，结果存在不一致的问题。

### 问题根源

1. **全局数据已包含坐标信息**：从数据库加载或导入的全局数据（`keyStratumData`）通常已经包含了X、Y坐标列
2. **重复合并导致问题**：前端将全局数据转为CSV后，后端再次尝试与坐标文件合并，导致：
   - 数据重复合并
   - 字段冲突或丢失
   - 建模结果不一致

## 修复方案

### 1. 后端API修改 (`backend/server.py`)

在 `/api/modeling/columns` 接口中添加 `use_merged_data` 参数：

**修改内容：**
- 新增 `use_merged_data: bool = Form(False)` 参数
- 坐标文件改为可选：`coords_file: UploadFile = File(None)`
- 根据 `use_merged_data` 标志决定处理方式：
  - `True`：直接加载数据，跳过坐标合并步骤
  - `False`：传统模式，需要坐标文件进行合并

**核心逻辑：**
```python
if use_merged_data:
    # 数据已包含坐标信息，直接加载
    merged_df = pd.concat(merged_frames, ignore_index=True)
    # 验证坐标列存在
    coord_candidates = ['X', 'x', 'X坐标', 'x坐标', 'Y', 'y', 'Y坐标', 'y坐标']
    found_coords = [col for col in merged_df.columns if any(cand in col for cand in coord_candidates)]
    if len(found_coords) < 2:
        raise HTTPException(status_code=400, detail="数据中未找到足够的坐标列")
    coords_df = None
else:
    # 传统模式：需要坐标文件进行合并
    merged_df, coords_df = aggregate_boreholes(borehole_paths, str(coords_path))
```

### 2. 前端逻辑修改 (`frontend/src/components/GeologicalModelingView.vue`)

#### 2.1 智能检测坐标信息

添加计算属性 `hasCoordinatesInGlobalData`：
```javascript
const hasCoordinatesInGlobalData = computed(() => {
  if (!useGlobalData.value || !globalDataStore.keyStratumColumns || 
      globalDataStore.keyStratumColumns.length === 0) {
    return false;
  }
  
  const coordColumns = ['X', 'x', 'X坐标', 'x坐标', 'Y', 'y', 'Y坐标', 'y坐标'];
  const hasX = coordColumns.some(coord => 
    globalDataStore.keyStratumColumns.some(col => col.includes(coord.includes('X') || coord.includes('x') ? 'x' : 'X'))
  );
  const hasY = coordColumns.some(coord => 
    globalDataStore.keyStratumColumns.some(col => col.includes(coord.includes('Y') || coord.includes('y') ? 'y' : 'Y'))
  );
  
  return hasX && hasY;
});
```

#### 2.2 修改数据加载逻辑

在 `loadAndMergeData` 函数中：
```javascript
if (useGlobalData.value) {
  // 检查全局数据是否已包含坐标信息
  const hasCoordinates = coordColumns.some(coord => 
    columns.some(col => col.includes(coord))
  );
  
  if (hasCoordinates) {
    // 数据已包含坐标，使用已合并数据模式
    useMergedData = true;
  } else {
    // 数据不包含坐标，需要坐标文件
    if (!coordsFile.value) {
      ElMessage.warning('全局数据不包含坐标信息，请上传坐标文件');
      return;
    }
  }
}

// 添加坐标文件（如果需要）
if (!useMergedData && coordsFile.value) {
  formData.append('coords_file', coordsFile.value);
}

// 添加标志参数
formData.append('use_merged_data', useMergedData.toString());
```

#### 2.3 UI改进

修改坐标文件上传区域，动态显示标签：
```vue
<h5>坐标文件 
  <el-tag v-if="!useGlobalData || !hasCoordinatesInGlobalData" size="small" type="danger">必需</el-tag>
  <el-tag v-else size="small" type="info">可选</el-tag>
</h5>
<div class="coords-summary">
  <span v-if="coordsFile">{{ coordsFile.name }} ({{ formatFileSize(coordsFile.size) }})</span>
  <span v-else-if="useGlobalData && hasCoordinatesInGlobalData" class="info-text">
    全局数据已包含坐标信息
  </span>
  <span v-else class="muted">未选择文件</span>
</div>
```

添加样式优化：
```css
.coords-summary .info-text { 
  color: #0ea5e9; 
  font-weight: 500;
  display: flex;
  align-items: center;
}
.coords-summary .info-text::before {
  content: '✓';
  margin-right: 6px;
  color: #10b981;
  font-weight: bold;
}
```

## 修复效果

### 使用全局数据（已包含坐标）
1. 系统自动检测全局数据包含X、Y坐标
2. 坐标文件标记为"可选"
3. 后端直接加载数据，不进行坐标合并
4. 建模结果与原始数据一致

### 使用全局数据（不包含坐标）
1. 系统检测全局数据缺少坐标
2. 坐标文件标记为"必需"
3. 用户必须上传坐标文件
4. 后端执行坐标合并操作

### 使用上传文件
1. 传统模式，必须提供钻孔文件和坐标文件
2. 后端执行完整的数据聚合和合并流程

## 数据一致性保证

修复后，无论使用全局数据还是上传新文件，只要数据源相同，建模结果将完全一致：

- ✅ 数据不会重复合并
- ✅ 字段不会冲突或丢失
- ✅ 坐标信息正确保留
- ✅ 插值计算基于相同的数据集
- ✅ 3D模型渲染结果一致

## 其他功能模块检查

经检查，其他功能模块的全局数据使用情况：

1. **关键层分析**：直接使用全局数据，不涉及坐标合并，无类似问题
2. **数据可视化**：从全局数据读取，不涉及数据处理，无问题
3. **数据导入导出**：直接操作原始数据，无问题

## 测试建议

### 测试场景1：全局数据已包含坐标
1. 在Dashboard导入包含X、Y坐标的钻孔数据
2. 进入地质建模模块
3. 选择"使用全局数据"
4. 观察坐标文件标记为"可选"
5. 不上传坐标文件，直接进行建模
6. 验证建模结果正确

### 测试场景2：全局数据不包含坐标
1. 在Dashboard导入不包含坐标的钻孔数据
2. 进入地质建模模块
3. 选择"使用全局数据"
4. 观察坐标文件标记为"必需"
5. 上传坐标文件
6. 验证数据正确合并，建模结果正确

### 测试场景3：对比全局数据和上传文件
1. 使用相同的数据文件
2. 分别测试"使用全局数据"和"上传新文件"两种方式
3. 对比两次建模结果
4. 验证结果完全一致（网格点位置、厚度值等）

## 维护建议

1. **数据导入时保留坐标**：确保在Dashboard导入数据时，坐标列（X、Y）不会被过滤或删除
2. **列名标准化**：建议统一使用标准列名（如"X坐标"、"Y坐标"），方便系统识别
3. **数据验证**：在数据导入时验证必需字段，提前发现问题
4. **日志记录**：保留详细的数据处理日志，便于问题追踪

## 相关文件

- `backend/server.py` - 后端API修改
- `frontend/src/components/GeologicalModelingView.vue` - 前端逻辑和UI修改
- `backend/coal_seam_blocks/aggregator.py` - 数据聚合模块（未修改）
- `frontend/src/stores/globalData.js` - 全局数据存储（未修改）

## 修复时间

2025年10月29日
