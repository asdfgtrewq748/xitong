# Z轴剖面功能说明

## 功能概述

在地质建模的剖面图功能中,新增了 **Z轴水平剖面** 功能,用于查看指定高程的平面岩性分布。

## 使用步骤

### 1. 生成3D模型

首先在地质建模页面完成3D块体模型的生成:

1. 上传钻孔数据和坐标文件
2. 选择坐标列、厚度列、岩层列
3. 选择要建模的岩层
4. 点击"生成 3D 块体模型"按钮

### 2. 打开剖面对话框

点击"查看地质剖面图"按钮,打开剖面对话框。

### 3. 选择Z轴剖面

在"剖面方向"下拉框中选择 **"Z轴水平剖面"**。

### 4. 调整Z高程

- 使用滑块或输入框调整 Z 高程位置
- Z 范围自动根据模型的最低底面和最高顶面计算
- 剖面会实时更新

### 5. 查看岩性分布

剖面图以散点图形式展示:

- **不同颜色区域**: 代表不同岩性的分布
- **图例**: 右侧显示各岩性的名称和对应颜色
- **鼠标悬停**: 可查看精确的 X、Y、Z 坐标
- **点击图例**: 可显示/隐藏特定岩性

## 技术实现

### 后端

#### 1. 数据处理模块 (`backend/z_section_slicer.py`)

- `extract_z_section()`: 提取指定 z 坐标的剖面数据
- `get_z_range_from_models()`: 获取模型的 z 范围
- `_get_layer_color()`: 根据岩性名称智能分配颜色

**核心逻辑**:
- 从块体模型中找到 z 坐标位于每个网格点的岩层
- 判断条件: `bottom <= z < top`
- 返回每个点的坐标、岩性名称、岩性索引、颜色等信息

#### 2. API接口 (`backend/server.py`)

- 端点: `POST /api/modeling/z_section`
- 请求参数: `{ "z_coordinate": float }`
- 返回数据:
  ```json
  {
    "status": "success",
    "z_coordinate": 100.0,
    "x_coords": [...],
    "y_coords": [...],
    "lithology": ["煤层", "砂岩", ...],
    "lithology_index": [0, 1, ...],
    "legend": [
      {"index": 0, "name": "煤层", "color": "#1a1a1a"},
      {"index": 1, "name": "砂岩", "color": "#f4a460"}
    ],
    "z_range": [50.0, 150.0],
    "grid_shape": [100, 100]
  }
  ```

#### 3. 模型状态缓存

在 `ModelingState` 类中新增字段:
- `last_block_models`: 存储最近生成的块体模型
- `last_grid_x`: 存储 X 网格坐标
- `last_grid_y`: 存储 Y 网格坐标

这些数据在生成3D模型时自动保存,供 z 剖面提取使用。

### 前端

#### 1. UI 改进

在剖面对话框中:
- 剖面方向下拉框新增 "Z轴水平剖面" 选项
- 位置标签动态显示 (X坐标/Y坐标/Z高程)
- 说明文本根据剖面类型显示不同内容

#### 2. 范围计算

`updateCrossSectionRange()` 函数:
- 对于 z 剖面,遍历所有模型的顶面和底面
- 计算全局最小 z 和最大 z
- 设置滑块范围和默认位置

#### 3. 剖面生成

`generateCrossSection()` 函数:
- 检测剖面方向
- 如果是 z 剖面,调用 `generateZSectionFromBackend()`
- 否则使用原有的 X/Y 剖面逻辑

#### 4. 数据渲染

`renderZSection()` 函数:
- 接收后端返回的剖面数据
- 按岩性索引分组数据
- 使用 ECharts 散点图渲染
- 配置图例、工具提示、坐标轴等

## 岩性颜色方案

系统自动根据岩性关键词匹配颜色:

| 岩性类型 | 关键词 | 颜色代码 |
|---------|-------|---------|
| 煤层 | 煤, coal | #1a1a1a (黑色) |
| 砂岩 | 砂, sand | #f4a460 (黄色) |
| 泥岩 | 泥, mud, 页 | #8b7355 (棕色) |
| 灰岩 | 灰, lime | #a9a9a9 (灰色) |
| 粉砂岩 | 粉, silt | #deb887 (浅黄) |
| 页岩 | 页, shale | #654321 (深棕) |
| 其他 | - | 默认调色板循环 |

## 注意事项

1. **必须先生成3D模型**: z 剖面功能依赖于已生成的块体模型
2. **Z范围提示**: 如果选择的 z 坐标超出模型范围,系统会在控制台输出警告
3. **无数据区域**: 超出模型范围的区域标记为"无数据"(灰色)
4. **性能考虑**: 大规模网格可能导致渲染较慢,建议控制分辨率在150-200范围

## 示例用例

### 查看煤层开采高度的岩性分布

1. 生成包含煤层的3D模型
2. 打开 z 剖面
3. 调整 z 高程到煤层顶面高度
4. 观察该高程的煤层分布范围和周围岩性

### 分析断层或褶皱

通过不同 z 高程的剖面,可以观察岩性分布的变化,识别地质构造。

## 未来改进方向

- [ ] 支持热力图模式 (除了散点图)
- [ ] 添加剖面导出为 GeoTIFF 格式
- [ ] 支持多个 z 剖面叠加对比
- [ ] 添加等高线叠加显示
- [ ] 优化大数据量渲染性能

---

**开发日期**: 2025年11月24日  
**功能状态**: ✅ 已完成核心功能,待实际数据测试
