# FLAC3D Grid 文件格式 (.f3grid) 规范

## 1. 格式概述

FLAC3D的.f3grid文件是一种**文本格式**的网格定义文件,直接定义网格点(gridpoints)和区域(zones)的拓扑关系,无需通过几何体生成网格。

### 优势
- ✅ **无几何冲突**: 直接定义网格,不会出现STL的体积重叠问题
- ✅ **层间连续**: 可以精确控制相邻层共享节点,保证应力传递
- ✅ **精确控制**: 每个网格点、每个zone都可以精确定义
- ✅ **分组管理**: 支持zone group,便于分层赋材料参数

### 劣势
- ❌ **文件较大**: 文本格式,大模型文件会很大
- ❌ **生成复杂**: 需要手工计算拓扑关系

## 2. 文件结构

```
; FLAC3D Grid File
; Generated by Geological Modeling System
; Date: 2025-11-23

; ============================================
; SECTION 1: Grid Points (节点定义)
; ============================================
GRIDPOINTS
  <gp_id> <x> <y> <z>
  <gp_id> <x> <y> <z>
  ...

; ============================================
; SECTION 2: Zones (单元定义)
; ============================================
ZONES BRICK
  <zone_id> <gp1> <gp2> <gp3> <gp4> <gp5> <gp6> <gp7> <gp8>
  <zone_id> <gp1> <gp2> <gp3> <gp4> <gp5> <gp6> <gp7> <gp8>
  ...

; ============================================
; SECTION 3: Groups (分组定义)
; ============================================
GROUP ZONE 'Layer_01' RANGE id <start_id> <end_id>
GROUP ZONE 'Layer_02' RANGE id <start_id> <end_id>
...
```

## 3. 核心概念

### 3.1 GridPoint (网格点/节点)
- 每个gridpoint有唯一ID和三维坐标(x,y,z)
- **相邻层共享节点**: 上一层的底面节点 = 下一层的顶面节点

### 3.2 Zone (单元)
FLAC3D支持多种zone类型,地质建模主要用:
- **BRICK (六面体)**: 8个节点,适合规则网格
- **WEDGE (楔形体)**: 6个节点
- **PYRAMID (金字塔)**: 5个节点
- **TETRA (四面体)**: 4个节点

**BRICK节点编号顺序**:
```
       7--------6
      /|       /|
     / |      / |
    4--------5  |
    |  3-----|--2
    | /      | /
    |/       |/
    0--------1

底面(z_bottom): 0-1-2-3 (逆时针)
顶面(z_top):    4-5-6-7 (逆时针)
```

### 3.3 Zone Group (分组)
- 用于标记不同地层
- 便于赋材料参数和边界条件
- 支持RANGE语法批量分组

## 4. 分层网格生成策略

### 4.1 单层网格生成

对于一个地层,输入:
- `top_surface[ny, nx]`: 顶面高程网格
- `bottom_surface[ny, nx]`: 底面高程网格

生成:
1. **底面节点** (ny×nx个):
   ```
   gp_id = layer_base_id + i*nx + j
   x = grid_x[i, j]
   y = grid_y[i, j]
   z = bottom_surface[i, j]
   ```

2. **顶面节点** (ny×nx个):
   ```
   gp_id = layer_base_id + ny*nx + i*nx + j
   x = grid_x[i, j]
   y = grid_y[i, j]
   z = top_surface[i, j]
   ```

3. **BRICK单元** ((ny-1)×(nx-1)个):
   ```
   对于每个网格单元(i,j):
   
   底面4个节点:
   n0 = layer_base_id + i*nx + j
   n1 = layer_base_id + i*nx + (j+1)
   n2 = layer_base_id + (i+1)*nx + (j+1)
   n3 = layer_base_id + (i+1)*nx + j
   
   顶面4个节点:
   n4 = n0 + ny*nx
   n5 = n1 + ny*nx
   n6 = n2 + ny*nx
   n7 = n3 + ny*nx
   
   zone_id: n0 n1 n2 n3 n4 n5 n6 n7
   ```

### 4.2 多层网格合并

**关键策略**: 相邻层共享interface节点

```python
Layer 1 (底层):
  - 底面节点: gp_1 ~ gp_N
  - 顶面节点: gp_(N+1) ~ gp_2N

Layer 2 (上层):
  - 底面节点: 复用 gp_(N+1) ~ gp_2N  ← 关键!
  - 顶面节点: gp_(2N+1) ~ gp_3N
```

这样保证:
- ✅ 层间节点完全重合(无间隙、无重叠)
- ✅ 应力自然传递(节点共享)
- ✅ 网格连续性(拓扑一致)

### 4.3 处理逐列排序后的数据

由于我们已经用`enforce_columnwise_order`保证:
- 任何(i,j)位置: `layer[k+1].bottom[i,j] >= layer[k].top[i,j] + gap`

在生成F3Grid时:
1. **忽略gap**: 强制让 `layer[k+1].bottom = layer[k].top`
2. **节点复用**: 上层底面直接用下层顶面的节点ID
3. **厚度调整**: 如果需要保持gap,可以在zone之间插入薄的interface层

## 5. 示例代码片段

### 5.1 简单2层模型

```python
# 假设: 3x3网格, 2层

# Layer 1: 节点 1-18
#   底面: 1-9
#   顶面: 10-18

# Layer 2: 节点 10-27 (底面复用Layer1的顶面)
#   底面: 10-18 (复用!)
#   顶面: 19-27

# GridPoints (27个)
GRIDPOINTS
1   0.0  0.0  0.0
2   50.0 0.0  0.0
3   100.0 0.0 0.0
...
10  0.0  0.0  5.0    ; Layer1顶面 = Layer2底面
...
27  100.0 100.0 15.0

# Zones (8个: 每层4个brick)
ZONES BRICK
; Layer 1
1  1 2 5 4  10 11 14 13
2  2 3 6 5  11 12 15 14
3  4 5 8 7  13 14 17 16
4  5 6 9 8  14 15 18 17

; Layer 2
5  10 11 14 13  19 20 23 22
6  11 12 15 14  20 21 24 23
7  13 14 17 16  22 23 26 25
8  14 15 18 17  23 24 27 26

# Groups
GROUP ZONE 'Layer_01' RANGE id 1 4
GROUP ZONE 'Layer_02' RANGE id 5 8
```

## 6. 实现清单

### 必需功能
- [ ] `_calculate_gridpoint_ids()`: 计算节点ID映射
- [ ] `_generate_gridpoints()`: 生成节点列表
- [ ] `_generate_brick_zones()`: 生成六面体单元
- [ ] `_write_f3grid_file()`: 写入文件
- [ ] `_create_zone_groups()`: 创建分组

### 可选功能
- [ ] 坐标归一化
- [ ] 网格降采样(粗化)
- [ ] 边界group标记
- [ ] 生成配套的FISH初始化脚本

## 7. 与STL方案对比

| 特性 | STL方案 | F3Grid方案 |
|------|---------|------------|
| 文件大小 | 中等 | 较大 |
| 几何冲突 | ❌ 易出现 | ✅ 无冲突 |
| 层间连续性 | ❌ 需手工attach | ✅ 自动连续 |
| 应力传递 | ⚠️ 需interface | ✅ 节点共享 |
| 生成复杂度 | 低 | 中等 |
| FLAC导入速度 | 快 | 很快 |
| 调试难度 | 中 | 低(文本格式) |

## 8. 注意事项

1. **节点编号**: 从1开始(FLAC3D约定)
2. **节点顺序**: BRICK的8个节点必须按FLAC规范排列
3. **右手系**: 确保法向量朝外
4. **浮点精度**: 坐标保留足够精度(建议6位小数)
5. **大模型优化**: 考虑二进制格式或分块导出

---

参考文档: FLAC3D 7.0 User's Manual - Grid Import/Export
